name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - 'misc/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - 'misc/**'

# Cancel in-progress runs when a new run is triggered on the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Fast formatting check - runs first and fast
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # Clippy linting - needs dependencies but can run parallel to tests
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libxkbcommon-dev libssl-dev libgtk-3-dev libpipewire-0.3-dev

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "clippy"

      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  # Build and test core library
  test-core:
    name: Test Core (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpipewire-0.3-dev

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-${{ runner.os }}"

      - name: Build core library
        run: cargo build -p croh-core

      - name: Run unit tests
        run: cargo test -p croh-core --lib

      - name: Run integration tests
        run: cargo test -p croh-core --test iroh_integration

  # Build GUI application (release only for artifacts)
  build-gui:
    name: Build GUI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact-name: croh-linux
            artifact-path: target/release/croh
          - os: windows-latest
            artifact-name: croh-windows
            artifact-path: target/release/croh.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libxkbcommon-dev libssl-dev libgtk-3-dev libpipewire-0.3-dev

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-${{ runner.os }}"

      - name: Build GUI (release)
        run: cargo build -p croh --release

      - name: Upload GUI binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}

  # Build daemon (release only for artifacts)
  build-daemon:
    name: Build Daemon (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact-name: croh-daemon-linux
            artifact-path: target/release/croh-daemon
          - os: windows-latest
            artifact-name: croh-daemon-windows
            artifact-path: target/release/croh-daemon.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpipewire-0.3-dev

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-${{ runner.os }}"

      - name: Build daemon (release)
        run: cargo build -p croh-daemon --release

      - name: Upload daemon binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}

  # Run comprehensive tests with relay
  test-relay:
    name: Test with Relay
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpipewire-0.3-dev

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-Linux"

      - name: Run relay tests
        run: cargo test -p croh-core --features test-relay

  # Summary job for branch protection rules
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [fmt, clippy, test-core, build-gui, build-daemon, test-relay]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]]; then
            echo "Format check failed"
            exit 1
          fi
          if [[ "${{ needs.clippy.result }}" != "success" ]]; then
            echo "Clippy failed"
            exit 1
          fi
          if [[ "${{ needs.test-core.result }}" != "success" ]]; then
            echo "Core tests failed"
            exit 1
          fi
          if [[ "${{ needs.build-gui.result }}" != "success" ]]; then
            echo "GUI build failed"
            exit 1
          fi
          if [[ "${{ needs.build-daemon.result }}" != "success" ]]; then
            echo "Daemon build failed"
            exit 1
          fi
          if [[ "${{ needs.test-relay.result }}" != "success" ]]; then
            echo "Relay tests failed"
            exit 1
          fi
          echo "All CI checks passed!"
