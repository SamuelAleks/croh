import { Button, VerticalBox, HorizontalBox, TabWidget, LineEdit, ProgressIndicator, ScrollView, ComboBox } from "std-widgets.slint";

// ============================================================================
// Theme Colors - Basic/Simple
// ============================================================================

global Theme {
    // Core background colors
    out property <color> bg-dark: #f5f5f5;
    out property <color> bg-card: #ffffff;
    out property <color> bg-hover: #e8e8e8;
    out property <color> bg-input: #585858;

    // Border & outline
    out property <color> border: #cccccc;
    out property <color> border-focus: #0066cc;

    // Text colors
    out property <color> text: #222222;
    out property <color> text-dim: #303030;
    out property <color> text-muted: #999999;

    // Accent - simple blue
    out property <color> accent: #0066cc;
    out property <color> accent-glow: #0066cc40;
    out property <color> accent-text: #ffffff;

    // Status colors
    out property <color> success: #228b22;
    out property <color> error: #cc0000;
    out property <color> warning: #cc8800;
    out property <color> info: #0066cc;

    // Transfer type colors
    out property <color> send-color: #228b22;
    out property <color> receive-color: #0066cc;

    // Sizing
    out property <length> radius-sm: 4px;
    out property <length> radius-md: 4px;
    out property <length> radius-lg: 4px;
    out property <length> spacing-xs: 4px;
    out property <length> spacing-sm: 8px;
    out property <length> spacing-md: 12px;
    out property <length> spacing-lg: 16px;
}

// ============================================================================
// Data Structures
// ============================================================================

export struct TransferItem {
    id: string,
    transfer-type: string,
    status: string,
    code: string,
    files: string,
    progress: float,
    speed: string,
    error: string,
}

export struct SelectedFile {
    name: string,
    size: string,
    path: string,
}

export struct AppSettings {
    download-dir: string,
    default-relay: string,
    theme: string,
    croc-path: string,
    croc-found: bool,
}

// ============================================================================
// Application Logic Interface
// ============================================================================

export global AppLogic {
    callback browse-files();
    callback clear-files();
    callback remove-file(int);
    callback start-send();
    callback start-receive(string);
    callback cancel-transfer(string);
    callback remove-transfer(string);
    callback copy-code(string);
    callback open-folder(string);
    callback browse-download-dir();
    callback save-settings(string, string, string);
    callback open-config-folder();
    callback refresh-croc();
    callback install-croc();
    
    in property <[SelectedFile]> selected-files: [];
    in property <[TransferItem]> transfers: [];
    in property <string> app-status: "Ready";
    in property <string> copied-code: "";
    in property <AppSettings> settings: {
        download-dir: "",
        default-relay: "",
        theme: "dark",
        croc-path: "",
        croc-found: false,
    };
}

// ============================================================================
// Compact Button
// ============================================================================

component CompactButton inherits Rectangle {
    in property <string> label;
    in property <bool> primary: false;
    in property <bool> enabled: true;
    callback clicked();

    height: 28px;
    min-width: 60px;
    horizontal-stretch: 0;
    border-radius: Theme.radius-sm;
    background: !enabled ? Theme.bg-hover :
                primary ? Theme.accent :
                touch.has-hover ? Theme.bg-hover : Theme.bg-card;
    border-width: primary ? 0 : 1px;
    border-color: Theme.border;
    opacity: enabled ? 1.0 : 0.5;

    touch := TouchArea {
        mouse-cursor: enabled ? pointer : default;
        clicked => { if (enabled) { root.clicked(); } }
    }

    Text {
        text: label;
        font-size: 12px;
        color: primary ? #ffffff : Theme.text;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ============================================================================
// Icon-only Button
// ============================================================================

component IconBtn inherits Rectangle {
    in property <string> icon;
    in property <color> icon-color: Theme.text-dim;
    callback clicked();
    
    width: 28px;
    height: 28px;
    border-radius: Theme.radius-sm;
    background: touch.has-hover ? Theme.bg-hover : transparent;
    
    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }
    
    Text {
        text: icon;
        font-size: 14px;
        color: touch.has-hover ? Theme.text : icon-color;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ============================================================================
// Status Badge
// ============================================================================

component StatusBadge inherits Rectangle {
    in property <string> status;

    height: 20px;

    HorizontalBox {
        padding-left: 4px;
        padding-right: 4px;
        spacing: 4px;
        alignment: center;

        Text {
            text: status == "running" ? "[Active]" :
                  status == "completed" ? "[Done]" :
                  status == "failed" ? "[Failed]" :
                  status == "pending" ? "[Waiting]" :
                  status == "cancelled" ? "[Cancelled]" : "[" + status + "]";
            font-size: 11px;
            color: status == "running" ? Theme.accent :
                   status == "completed" ? Theme.success :
                   status == "failed" ? Theme.error :
                   status == "pending" ? Theme.warning :
                   Theme.text-dim;
        }
    }
}

// ============================================================================
// Code Badge (copyable)
// ============================================================================

component CodeBadge inherits Rectangle {
    in property <string> code;
    in property <bool> copied: false;
    callback clicked();

    height: 24px;
    border-radius: Theme.radius-sm;
    background: Theme.bg-input;
    border-width: 1px;
    border-color: Theme.border;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    HorizontalBox {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 6px;
        alignment: center;

        Text {
            text: code;
            font-size: 12px;
            color: #ffffff;
        }

        Text {
            text: copied ? "(copied)" : "(copy)";
            font-size: 10px;
            color: copied ? Theme.success : #cccccc;
        }
    }
}

// ============================================================================
// File Item (compact)
// ============================================================================

component FileItem inherits Rectangle {
    in property <string> name;
    in property <string> size;
    in property <int> index;

    height: 28px;
    background: transparent;

    touch := TouchArea {}

    HorizontalBox {
        padding-left: 8px;
        padding-right: 4px;
        spacing: 8px;

        Text {
            text: name;
            font-size: 12px;
            color: Theme.text;
            overflow: elide;
            horizontal-stretch: 1;
            vertical-alignment: center;
        }

        Text {
            text: size;
            font-size: 11px;
            color: Theme.text-muted;
            vertical-alignment: center;
        }

        IconBtn {
            icon: "x";
            icon-color: Theme.text-muted;
            clicked => { AppLogic.remove-file(index); }
        }
    }
}

// ============================================================================
// Transfer Card (very compact)
// ============================================================================

component TransferCard inherits Rectangle {
    in property <TransferItem> transfer;

    background: Theme.bg-card;
    border-radius: 2px;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: 4px;
        spacing: 2px;

        // Single row with all info
        HorizontalLayout {
            spacing: 6px;

            // Direction
            Text {
                text: transfer.transfer-type == "send" ? "↑" : "↓";
                font-size: 11px;
                color: transfer.transfer-type == "send" ? Theme.send-color : Theme.receive-color;
                vertical-alignment: center;
            }

            // Files
            Text {
                text: transfer.files;
                font-size: 11px;
                color: #222222;
                overflow: elide;
                horizontal-stretch: 1;
                vertical-alignment: center;
            }

            // Code (if available)
            if transfer.code != "": Rectangle {
                background: #484848;
                border-radius: 2px;
                height: 18px;

                code-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => { AppLogic.copy-code(transfer.code); }
                }

                HorizontalLayout {
                    padding-left: 6px;
                    padding-right: 6px;

                    Text {
                        text: transfer.code;
                        font-size: 10px;
                        color: #ffffff;
                        vertical-alignment: center;
                    }
                }
            }

            // Speed (if running and available)
            if transfer.status == "running" && transfer.speed != "": Text {
                text: transfer.speed;
                font-size: 10px;
                color: #888888;
                vertical-alignment: center;
            }

            // Progress % (if running)
            if transfer.status == "running": Text {
                text: Math.round(transfer.progress) + "%";
                font-size: 10px;
                color: transfer.progress > 0 ? Theme.accent : #666666;
                vertical-alignment: center;
            }

            // Status
            Text {
                text: transfer.status == "running" ? "●" :
                      transfer.status == "completed" ? "✓" :
                      transfer.status == "failed" ? "✗" : "○";
                font-size: 11px;
                color: transfer.status == "running" ? Theme.accent :
                       transfer.status == "completed" ? Theme.success :
                       transfer.status == "failed" ? Theme.error : #999999;
                vertical-alignment: center;
            }

            // Cancel button (if running)
            if transfer.status == "running": IconBtn {
                icon: "×";
                icon-color: Theme.error;
                clicked => { AppLogic.cancel-transfer(transfer.id); }
            }

            // Remove button (if completed, failed, or cancelled)
            if transfer.status == "completed" || transfer.status == "failed" || transfer.status == "cancelled": IconBtn {
                icon: "×";
                icon-color: Theme.text-muted;
                clicked => { AppLogic.remove-transfer(transfer.id); }
            }
        }

        // Progress bar (thin) - always show when running
        if transfer.status == "running": Rectangle {
            height: 3px;
            background: #e0e0e0;
            border-radius: 1px;

            Rectangle {
                x: 0;
                width: transfer.progress > 0 ? parent.width * (transfer.progress / 100.0) : 0;
                height: parent.height;
                background: Theme.accent;
                border-radius: 1px;
            }

            // Indeterminate animation indicator when progress is 0
            if transfer.progress == 0: Rectangle {
                x: mod(animation-tick() / 50ms, parent.width / 1px) * 1px;
                width: 40px;
                height: parent.height;
                background: Theme.accent;
                opacity: 0.5;
                border-radius: 1px;
            }
        }

        // Error (compact)
        if transfer.status == "failed" && transfer.error != "": Text {
            text: transfer.error;
            font-size: 10px;
            color: Theme.error;
            overflow: elide;
        }
    }
}

// ============================================================================
// Drop Zone
// ============================================================================

component DropZone inherits Rectangle {
    callback clicked();

    height: 80px;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;
    background: Theme.bg-card;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    VerticalBox {
        alignment: center;
        spacing: 4px;

        Text {
            text: "Drop files here or click to browse";
            font-size: 13px;
            color: Theme.text;
            horizontal-alignment: center;
        }
    }
}

// ============================================================================
// Compact Input with Label
// ============================================================================

component LabeledInput inherits VerticalLayout {
    in property <string> label;
    in property <string> placeholder: "";
    in-out property <string> value;

    spacing: 4px;

    Text {
        text: label;
        font-size: 12px;
        color: Theme.text;
    }

    LineEdit {
        text <=> value;
        placeholder-text: placeholder;
        font-size: 13px;
    }
}

// ============================================================================
// Setting Row (compact)
// ============================================================================

component SettingRow inherits Rectangle {
    in property <string> label;
    in property <string> sublabel: "";

    min-height: sublabel == "" ? 40px : 52px;

    HorizontalLayout {
        padding: Theme.spacing-sm;
        spacing: Theme.spacing-md;
        alignment: center;

        VerticalLayout {
            horizontal-stretch: 1;
            alignment: center;
            spacing: 2px;

            Text {
                text: label;
                font-size: 13px;
                color: Theme.text;
            }

            if sublabel != "": Text {
                text: sublabel;
                font-size: 11px;
                color: Theme.text-muted;
                overflow: elide;
            }
        }

        @children
    }
}

// ============================================================================
// Section Card
// ============================================================================

component Section inherits Rectangle {
    in property <string> title: "";

    background: Theme.bg-card;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;

    VerticalBox {
        padding: Theme.spacing-sm;
        spacing: Theme.spacing-sm;

        if title != "": Text {
            text: title;
            font-size: 11px;
            color: Theme.text-dim;
        }

        @children
    }
}

// ============================================================================
// Pill Tab Selector
// ============================================================================

component PillTabs inherits Rectangle {
    in property <[string]> tabs;
    in-out property <int> current: 0;
    callback changed(int);

    height: 32px;
    background: Theme.bg-card;
    border-width: 1px;
    border-color: Theme.border;

    HorizontalBox {
        padding: 2px;
        spacing: 0;

        for tab[i] in tabs: Rectangle {
            horizontal-stretch: 1;
            border-width: 0;
            border-color: Theme.border;
            background: i == current ? Theme.bg-hover : transparent;

            pill-touch := TouchArea {
                mouse-cursor: pointer;
                clicked => {
                    current = i;
                    changed(i);
                }
            }

            Text {
                text: tab;
                font-size: 12px;
                color: i == current ? Theme.text : Theme.text-dim;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

// ============================================================================
// Send Panel
// ============================================================================

component SendPanel inherits Rectangle {
    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        DropZone {
            clicked => { AppLogic.browse-files(); }
        }

        // Selected files - fixed height based on content
        if AppLogic.selected-files.length > 0: Rectangle {
            background: Theme.bg-card;
            border-radius: Theme.radius-sm;
            border-width: 1px;
            border-color: Theme.border;

            VerticalLayout {
                padding: 6px;
                spacing: 2px;

                Text {
                    text: "Selected (" + AppLogic.selected-files.length + ")";
                    font-size: 11px;
                    color: #666666;
                }

                // File list - compact
                for file[i] in AppLogic.selected-files: Rectangle {
                    height: 22px;
                    background: Math.mod(i, 2) == 0 ? #f8f8f8 : #ffffff;

                    HorizontalLayout {
                        padding-left: 6px;
                        padding-right: 4px;
                        spacing: 6px;

                        Text {
                            text: file.name;
                            font-size: 11px;
                            color: #222222;
                            overflow: elide;
                            horizontal-stretch: 1;
                            vertical-alignment: center;
                        }

                        Text {
                            text: file.size;
                            font-size: 10px;
                            color: #888888;
                            vertical-alignment: center;
                        }

                        IconBtn {
                            icon: "×";
                            icon-color: #888888;
                            clicked => { AppLogic.remove-file(i); }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    padding-top: 4px;

                    CompactButton {
                        label: "Clear";
                        clicked => { AppLogic.clear-files(); }
                    }

                    Rectangle { horizontal-stretch: 1; }

                    CompactButton {
                        label: "Send";
                        primary: true;
                        enabled: AppLogic.selected-files.length > 0;
                        clicked => { AppLogic.start-send(); }
                    }
                }
            }
        }

        // Spacer pushes transfers bar to fill remaining space
        Rectangle {
            vertical-stretch: 1;
            background: transparent;
        }
    }
}

// ============================================================================
// Receive Panel
// ============================================================================

component ReceivePanel inherits Rectangle {
    in-out property <string> code: "";

    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        Section {
            VerticalBox {
                spacing: Theme.spacing-sm;

                LabeledInput {
                    label: "Transfer Code";
                    placeholder: "e.g. 7-alpha-beta-gamma";
                    value <=> code;
                }

                HorizontalBox {
                    Rectangle { horizontal-stretch: 1; }

                    CompactButton {
                        label: "Receive";
                        primary: true;
                        enabled: code != "";
                        clicked => {
                            AppLogic.start-receive(code);
                            code = "";
                        }
                    }
                }
            }
        }

        Rectangle { vertical-stretch: 1; }
    }
}

// ============================================================================
// Peers Panel
// ============================================================================

component PeersPanel inherits Rectangle {
    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        Section {
            vertical-stretch: 1;

            VerticalBox {
                alignment: center;
                spacing: Theme.spacing-sm;

                Text {
                    text: "Trusted Peers";
                    font-size: 14px;
                    color: Theme.text;
                    horizontal-alignment: center;
                }

                Text {
                    text: "P2P connections coming soon";
                    font-size: 12px;
                    color: Theme.text-dim;
                    horizontal-alignment: center;
                }
            }
        }
    }
}

// ============================================================================
// Settings Panel
// ============================================================================

component SettingsPanel inherits Rectangle {
    in-out property <string> download-dir: AppLogic.settings.download-dir;
    in-out property <string> relay: AppLogic.settings.default-relay;
    in-out property <int> theme-idx: AppLogic.settings.theme == "light" ? 1 : AppLogic.settings.theme == "dark" ? 2 : 0;

    background: Theme.bg-dark;

    ScrollView {
        VerticalBox {
            padding: Theme.spacing-md;
            spacing: Theme.spacing-sm;

            // Downloads
            Section {
                title: "Downloads";

                SettingRow {
                    label: "Save Location";
                    sublabel: download-dir == "" ? "Default system downloads" : download-dir;

                    CompactButton {
                        label: "Browse";
                        clicked => { AppLogic.browse-download-dir(); }
                    }
                }
            }

            // Network
            Section {
                title: "Network";

                SettingRow {
                    label: "Custom Relay";
                    sublabel: "Leave empty for default";

                    LineEdit {
                        width: 160px;
                        text <=> relay;
                        placeholder-text: "relay.example.com";
                        font-size: 12px;
                    }
                }
            }

            // Appearance
            Section {
                title: "Appearance";

                SettingRow {
                    label: "Theme";

                    ComboBox {
                        width: 100px;
                        model: ["System", "Light", "Dark"];
                        current-index <=> theme-idx;
                    }
                }
            }

            // About
            Section {
                title: "About";

                SettingRow {
                    label: "Croc";
                    sublabel: AppLogic.settings.croc-found ? AppLogic.settings.croc-path : "Not found - required for transfers";

                    HorizontalLayout {
                        spacing: 4px;
                        alignment: center;

                        Rectangle {
                            width: 60px;
                            height: 20px;

                            Text {
                                text: AppLogic.settings.croc-found ? "[OK]" : "[Missing]";
                                font-size: 11px;
                                color: AppLogic.settings.croc-found ? Theme.success : Theme.error;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        CompactButton {
                            label: "Refresh";
                            clicked => { AppLogic.refresh-croc(); }
                        }

                        if !AppLogic.settings.croc-found: CompactButton {
                            label: "Install";
                            primary: true;
                            clicked => { AppLogic.install-croc(); }
                        }
                    }
                }

                SettingRow {
                    label: "Version";
                    sublabel: "Croh v0.1.0";

                    CompactButton {
                        label: "Config";
                        clicked => { AppLogic.open-config-folder(); }
                    }
                }
            }

            // Save
            HorizontalBox {
                Rectangle { horizontal-stretch: 1; }

                CompactButton {
                    label: "Save Settings";
                    primary: true;
                    clicked => {
                        AppLogic.save-settings(
                            download-dir,
                            relay,
                            theme-idx == 0 ? "system" : theme-idx == 1 ? "light" : "dark"
                        );
                    }
                }
            }
        }
    }
}

// ============================================================================
// Transfers Panel (bottom bar) - grows with window
// ============================================================================

component TransfersBar inherits Rectangle {
    background: Theme.bg-card;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: 4px;
        spacing: 2px;

        // Header
        Text {
            text: "Transfers (" + AppLogic.transfers.length + ")";
            font-size: 10px;
            color: #888888;
        }

        // Content
        if AppLogic.transfers.length == 0: Text {
            text: "No transfers";
            font-size: 10px;
            color: #aaaaaa;
            horizontal-alignment: center;
            vertical-alignment: center;
            vertical-stretch: 1;
        }

        // Transfer list - scrollable
        if AppLogic.transfers.length > 0: Flickable {
            vertical-stretch: 1;
            viewport-height: AppLogic.transfers.length * 32px;

            VerticalLayout {
                spacing: 2px;

                for transfer in AppLogic.transfers: TransferCard {
                    transfer: transfer;
                }
            }
        }
    }
}

// ============================================================================
// Main Window
// ============================================================================

export component MainWindow inherits Window {
    title: "Croh";
    min-width: 480px;
    min-height: 400px;
    preferred-width: 600px;
    preferred-height: 500px;
    background: Theme.bg-dark;

    property <int> active-tab: 0;

    VerticalLayout {
        spacing: 0;

        // Header
        Rectangle {
            height: 40px;
            background: Theme.bg-card;
            border-width: 1px;
            border-color: Theme.border;

            HorizontalLayout {
                padding: 8px;
                padding-left: 12px;
                padding-right: 12px;
                alignment: space-between;

                Text {
                    text: "Croh";
                    font-size: 14px;
                    color: Theme.text;
                    vertical-alignment: center;
                }

                Text {
                    text: AppLogic.app-status;
                    font-size: 11px;
                    color: Theme.text-dim;
                    vertical-alignment: center;
                }
            }
        }

        // Tabs
        Rectangle {
            height: 40px;
            background: Theme.bg-dark;

            HorizontalLayout {
                padding: 4px;
                padding-left: 8px;
                padding-right: 8px;

                PillTabs {
                    tabs: ["Send", "Receive", "Peers", "Settings"];
                    current <=> active-tab;
                }
            }
        }

        // Content - does not stretch
        Rectangle {
            if active-tab == 0: SendPanel {}
            if active-tab == 1: ReceivePanel {}
            if active-tab == 2: PeersPanel {}
            if active-tab == 3: SettingsPanel {}
        }

        // Transfers bar - grows with window
        TransfersBar {
            vertical-stretch: 1;
            min-height: 60px;
        }
    }
}
