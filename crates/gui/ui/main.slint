import { Button, VerticalBox, HorizontalBox, TabWidget, LineEdit, ProgressIndicator, ScrollView, ComboBox } from "std-widgets.slint";

// ============================================================================
// Theme Colors - Basic/Simple
// ============================================================================

global Theme {
    // Core background colors
    out property <color> bg-dark: #f5f5f5;
    out property <color> bg-card: #ffffff;
    out property <color> bg-hover: #e8e8e8;
    out property <color> bg-input: #585858;

    // Border & outline
    out property <color> border: #cccccc;
    out property <color> border-focus: #0066cc;

    // Text colors
    out property <color> text: #222222;
    out property <color> text-dim: #303030;
    out property <color> text-muted: #999999;

    // Accent - simple blue
    out property <color> accent: #0066cc;
    out property <color> accent-glow: #0066cc40;
    out property <color> accent-text: #ffffff;

    // Status colors
    out property <color> success: #228b22;
    out property <color> error: #cc0000;
    out property <color> warning: #cc8800;
    out property <color> info: #0066cc;

    // Transfer type colors
    out property <color> send-color: #228b22;
    out property <color> receive-color: #0066cc;

    // Sizing
    out property <length> radius-sm: 4px;
    out property <length> radius-md: 4px;
    out property <length> radius-lg: 4px;
    out property <length> spacing-xs: 4px;
    out property <length> spacing-sm: 8px;
    out property <length> spacing-md: 12px;
    out property <length> spacing-lg: 16px;
}

// ============================================================================
// Data Structures
// ============================================================================

export struct TransferItem {
    id: string,
    transfer-type: string,
    status: string,
    code: string,
    files: string,
    progress: float,
    speed: string,
    error: string,
}

export struct SelectedFile {
    name: string,
    size: string,
    path: string,
}

export struct AppSettings {
    download-dir: string,
    default-relay: string,
    theme: string,
    croc-path: string,
    croc-found: bool,
    // Transfer options
    hash-algorithm: string,  // "xxhash", "imohash", "md5", or "" for default
    curve: string,           // "siec", "p256", "p384", "p521", or "" for default
    throttle: string,        // bandwidth limit e.g. "1M", "500K", or "" for unlimited
    no-local: bool,          // force relay-only transfers
}

export struct PeerItem {
    id: string,
    name: string,
    endpoint-id: string,
    status: string,          // "online", "offline", "connecting"
    last-seen: string,
    can-push: bool,          // permission to push files to this peer
    can-pull: bool,          // permission to pull files from this peer
}

export struct BrowseEntry {
    name: string,
    is-dir: bool,
    size: string,
    modified: string,
    path: string,            // full path for selection
    selected: bool,
}

// ============================================================================
// Application Logic Interface
// ============================================================================

export global AppLogic {
    callback browse-files();
    callback clear-files();
    callback remove-file(int);
    callback start-send(string);  // custom code phrase (empty = auto-generate)
    callback start-receive(string);
    callback cancel-transfer(string);
    callback remove-transfer(string);
    callback copy-code(string);
    callback open-folder(string);
    callback browse-download-dir();
    // save-settings: download-dir, relay, theme, hash, curve, throttle, no-local
    callback save-settings(string, string, string, string, string, string, bool);
    callback open-config-folder();
    callback refresh-croc();
    callback install-croc();

    // Trusted peers callbacks
    callback initiate-trust();
    callback cancel-trust();
    callback remove-peer(string);  // peer id
    callback push-to-peer(string); // peer id - push selected files to peer
    callback pull-from-peer(string); // peer id - open browse dialog for peer

    // File browser callbacks (for remote peer browsing)
    callback browse-peer(string);              // peer id - start browsing
    callback browse-navigate(string);          // path - navigate to directory
    callback browse-toggle-select(int);        // index - toggle file selection
    callback browse-pull-selected();           // pull all selected files
    callback browse-close();                   // close browser dialog

    in property <[SelectedFile]> selected-files: [];
    in property <[TransferItem]> transfers: [];
    in property <string> app-status: "Ready";
    in property <string> copied-code: "";
    in property <AppSettings> settings: {
        download-dir: "",
        default-relay: "",
        theme: "dark",
        croc-path: "",
        croc-found: false,
        hash-algorithm: "",
        curve: "",
        throttle: "",
        no-local: false,
    };

    // Trusted peers state
    in property <[PeerItem]> peers: [];
    in property <bool> trust-in-progress: false;
    in property <string> trust-code: "";
    in property <string> endpoint-id: "";

    // File browser state
    in property <bool> browse-open: false;
    in property <string> browse-peer-id: "";
    in property <string> browse-peer-name: "";
    in property <string> browse-current-path: "/";
    in property <[BrowseEntry]> browse-entries: [];
    in property <bool> browse-loading: false;
    in property <string> browse-error: "";
}

// ============================================================================
// Compact Button
// ============================================================================

component CompactButton inherits Rectangle {
    in property <string> label;
    in property <bool> primary: false;
    in property <bool> enabled: true;
    callback clicked();

    height: 28px;
    min-width: 60px;
    horizontal-stretch: 0;
    border-radius: Theme.radius-sm;
    background: !enabled ? Theme.bg-hover :
                primary ? Theme.accent :
                touch.has-hover ? Theme.bg-hover : Theme.bg-card;
    border-width: primary ? 0 : 1px;
    border-color: Theme.border;
    opacity: enabled ? 1.0 : 0.5;

    touch := TouchArea {
        mouse-cursor: enabled ? pointer : default;
        clicked => { if (enabled) { root.clicked(); } }
    }

    Text {
        text: label;
        font-size: 12px;
        color: primary ? #ffffff : Theme.text;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ============================================================================
// Icon-only Button
// ============================================================================

component IconBtn inherits Rectangle {
    in property <string> icon;
    in property <color> icon-color: Theme.text-dim;
    callback clicked();
    
    width: 28px;
    height: 28px;
    border-radius: Theme.radius-sm;
    background: touch.has-hover ? Theme.bg-hover : transparent;
    
    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }
    
    Text {
        text: icon;
        font-size: 14px;
        color: touch.has-hover ? Theme.text : icon-color;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ============================================================================
// Status Badge
// ============================================================================

component StatusBadge inherits Rectangle {
    in property <string> status;

    height: 20px;

    HorizontalBox {
        padding-left: 4px;
        padding-right: 4px;
        spacing: 4px;
        alignment: center;

        Text {
            text: status == "running" ? "[Active]" :
                  status == "completed" ? "[Done]" :
                  status == "failed" ? "[Failed]" :
                  status == "pending" ? "[Waiting]" :
                  status == "cancelled" ? "[Cancelled]" : "[" + status + "]";
            font-size: 11px;
            color: status == "running" ? Theme.accent :
                   status == "completed" ? Theme.success :
                   status == "failed" ? Theme.error :
                   status == "pending" ? Theme.warning :
                   Theme.text-dim;
        }
    }
}

// ============================================================================
// Code Badge (copyable)
// ============================================================================

component CodeBadge inherits Rectangle {
    in property <string> code;
    in property <bool> copied: false;
    callback clicked();

    height: 24px;
    border-radius: Theme.radius-sm;
    background: Theme.bg-input;
    border-width: 1px;
    border-color: Theme.border;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    HorizontalBox {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 6px;
        alignment: center;

        Text {
            text: code;
            font-size: 12px;
            color: #ffffff;
        }

        Text {
            text: copied ? "(copied)" : "(copy)";
            font-size: 10px;
            color: copied ? Theme.success : #cccccc;
        }
    }
}

// ============================================================================
// File Item (compact)
// ============================================================================

component FileItem inherits Rectangle {
    in property <string> name;
    in property <string> size;
    in property <int> index;

    height: 28px;
    background: transparent;

    touch := TouchArea {}

    HorizontalBox {
        padding-left: 8px;
        padding-right: 4px;
        spacing: 8px;

        Text {
            text: name;
            font-size: 12px;
            color: Theme.text;
            overflow: elide;
            horizontal-stretch: 1;
            vertical-alignment: center;
        }

        Text {
            text: size;
            font-size: 11px;
            color: Theme.text-muted;
            vertical-alignment: center;
        }

        IconBtn {
            icon: "x";
            icon-color: Theme.text-muted;
            clicked => { AppLogic.remove-file(index); }
        }
    }
}

// ============================================================================
// Transfer Card (very compact)
// ============================================================================

component TransferCard inherits Rectangle {
    in property <TransferItem> transfer;

    background: Theme.bg-card;
    border-radius: 2px;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: 4px;
        spacing: 2px;

        // Single row with all info
        HorizontalLayout {
            spacing: 6px;

            // Direction
            Text {
                text: transfer.transfer-type == "send" ? "â†‘" : "â†“";
                font-size: 11px;
                color: transfer.transfer-type == "send" ? Theme.send-color : Theme.receive-color;
                vertical-alignment: center;
            }

            // Files
            Text {
                text: transfer.files;
                font-size: 11px;
                color: #222222;
                overflow: elide;
                horizontal-stretch: 1;
                vertical-alignment: center;
            }

            // Code (if available)
            if transfer.code != "": Rectangle {
                background: #484848;
                border-radius: 2px;
                height: 18px;

                code-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => { AppLogic.copy-code(transfer.code); }
                }

                HorizontalLayout {
                    padding-left: 6px;
                    padding-right: 6px;

                    Text {
                        text: transfer.code;
                        font-size: 10px;
                        color: #ffffff;
                        vertical-alignment: center;
                    }
                }
            }

            // Speed (if running and available)
            if transfer.status == "running" && transfer.speed != "": Text {
                text: transfer.speed;
                font-size: 10px;
                color: #888888;
                vertical-alignment: center;
            }

            // Progress % (if running)
            if transfer.status == "running": Text {
                text: Math.round(transfer.progress) + "%";
                font-size: 10px;
                color: transfer.progress > 0 ? Theme.accent : #666666;
                vertical-alignment: center;
            }

            // Status
            Text {
                text: transfer.status == "running" ? "â—" :
                      transfer.status == "completed" ? "âœ“" :
                      transfer.status == "failed" ? "âœ—" : "â—‹";
                font-size: 11px;
                color: transfer.status == "running" ? Theme.accent :
                       transfer.status == "completed" ? Theme.success :
                       transfer.status == "failed" ? Theme.error : #999999;
                vertical-alignment: center;
            }

            // Cancel button (if running)
            if transfer.status == "running": IconBtn {
                icon: "Ã—";
                icon-color: Theme.error;
                clicked => { AppLogic.cancel-transfer(transfer.id); }
            }

            // Remove button (if completed, failed, or cancelled)
            if transfer.status == "completed" || transfer.status == "failed" || transfer.status == "cancelled": IconBtn {
                icon: "Ã—";
                icon-color: Theme.text-muted;
                clicked => { AppLogic.remove-transfer(transfer.id); }
            }
        }

        // Progress bar (thin) - always show when running
        if transfer.status == "running": Rectangle {
            height: 3px;
            background: #e0e0e0;
            border-radius: 1px;

            Rectangle {
                x: 0;
                width: transfer.progress > 0 ? parent.width * (transfer.progress / 100.0) : 0;
                height: parent.height;
                background: Theme.accent;
                border-radius: 1px;
            }

            // Indeterminate animation indicator when progress is 0
            if transfer.progress == 0: Rectangle {
                x: mod(animation-tick() / 50ms, parent.width / 1px) * 1px;
                width: 40px;
                height: parent.height;
                background: Theme.accent;
                opacity: 0.5;
                border-radius: 1px;
            }
        }

        // Error (compact)
        if transfer.status == "failed" && transfer.error != "": Text {
            text: transfer.error;
            font-size: 10px;
            color: Theme.error;
            overflow: elide;
        }
    }
}

// ============================================================================
// Drop Zone
// ============================================================================

component DropZone inherits Rectangle {
    callback clicked();

    height: 80px;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;
    background: Theme.bg-card;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    VerticalBox {
        alignment: center;
        spacing: 4px;

        Text {
            text: "Drop files here or click to browse";
            font-size: 13px;
            color: Theme.text;
            horizontal-alignment: center;
        }
    }
}

// ============================================================================
// Compact Input with Label
// ============================================================================

component LabeledInput inherits VerticalLayout {
    in property <string> label;
    in property <string> placeholder: "";
    in-out property <string> value;

    spacing: 4px;

    Text {
        text: label;
        font-size: 12px;
        color: Theme.text;
    }

    LineEdit {
        text <=> value;
        placeholder-text: placeholder;
        font-size: 13px;
    }
}

// ============================================================================
// Setting Row (compact)
// ============================================================================

component SettingRow inherits Rectangle {
    in property <string> label;
    in property <string> sublabel: "";

    height: sublabel == "" ? 36px : 48px;

    HorizontalLayout {
        padding-left: Theme.spacing-sm;
        padding-right: Theme.spacing-sm;
        spacing: Theme.spacing-md;

        // Label section - left aligned, vertically centered
        VerticalLayout {
            horizontal-stretch: 1;
            alignment: center;
            spacing: 2px;

            Text {
                text: label;
                font-size: 13px;
                color: Theme.text;
            }

            if sublabel != "": Text {
                text: sublabel;
                font-size: 11px;
                color: Theme.text-muted;
                overflow: elide;
            }
        }

        // Controls section - right aligned, vertically centered
        VerticalLayout {
            alignment: center;
            @children
        }
    }
}

// ============================================================================
// Section Card
// ============================================================================

component Section inherits Rectangle {
    in property <string> title: "";

    background: Theme.bg-card;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: Theme.spacing-sm;
        spacing: 4px;

        if title != "": Text {
            text: title;
            font-size: 11px;
            font-weight: 500;
            color: Theme.text-muted;
        }

        @children
    }
}

// ============================================================================
// Pill Tab Selector
// ============================================================================

component PillTabs inherits Rectangle {
    in property <[string]> tabs;
    in-out property <int> current: 0;
    callback changed(int);

    height: 32px;
    background: Theme.bg-card;
    border-width: 1px;
    border-color: Theme.border;

    HorizontalBox {
        padding: 2px;
        spacing: 0;

        for tab[i] in tabs: Rectangle {
            horizontal-stretch: 1;
            border-width: 0;
            border-color: Theme.border;
            background: i == current ? Theme.bg-hover : transparent;

            pill-touch := TouchArea {
                mouse-cursor: pointer;
                clicked => {
                    current = i;
                    changed(i);
                }
            }

            Text {
                text: tab;
                font-size: 12px;
                color: i == current ? Theme.text : Theme.text-dim;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

// ============================================================================
// Send Panel
// ============================================================================

component SendPanel inherits Rectangle {
    in-out property <string> custom-code: "";

    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        DropZone {
            clicked => { AppLogic.browse-files(); }
        }

        // Selected files - fixed height based on content
        if AppLogic.selected-files.length > 0: Rectangle {
            background: Theme.bg-card;
            border-radius: Theme.radius-sm;
            border-width: 1px;
            border-color: Theme.border;

            VerticalLayout {
                padding: 6px;
                spacing: 2px;

                Text {
                    text: "Selected (" + AppLogic.selected-files.length + ")";
                    font-size: 11px;
                    color: #666666;
                }

                // File list - compact
                for file[i] in AppLogic.selected-files: Rectangle {
                    height: 22px;
                    background: Math.mod(i, 2) == 0 ? #f8f8f8 : #ffffff;

                    HorizontalLayout {
                        padding-left: 6px;
                        padding-right: 4px;
                        spacing: 6px;

                        Text {
                            text: file.name;
                            font-size: 11px;
                            color: #222222;
                            overflow: elide;
                            horizontal-stretch: 1;
                            vertical-alignment: center;
                        }

                        Text {
                            text: file.size;
                            font-size: 10px;
                            color: #888888;
                            vertical-alignment: center;
                        }

                        IconBtn {
                            icon: "Ã—";
                            icon-color: #888888;
                            clicked => { AppLogic.remove-file(i); }
                        }
                    }
                }

                // Custom code input (optional)
                HorizontalLayout {
                    spacing: 6px;
                    padding-top: 4px;

                    Text {
                        text: "Code:";
                        font-size: 11px;
                        color: #666666;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        horizontal-stretch: 1;
                        text <=> custom-code;
                        placeholder-text: "auto-generate";
                        font-size: 11px;
                    }
                }

                HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    padding-top: 4px;

                    CompactButton {
                        label: "Clear";
                        clicked => { AppLogic.clear-files(); }
                    }

                    Rectangle { horizontal-stretch: 1; }

                    CompactButton {
                        label: "Send";
                        primary: true;
                        enabled: AppLogic.selected-files.length > 0;
                        clicked => {
                            AppLogic.start-send(custom-code);
                            custom-code = "";
                        }
                    }
                }
            }
        }

        // Spacer pushes transfers bar to fill remaining space
        Rectangle {
            vertical-stretch: 1;
            background: transparent;
        }
    }
}

// ============================================================================
// Receive Panel
// ============================================================================

component ReceivePanel inherits Rectangle {
    in-out property <string> code: "";

    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        Section {
            VerticalBox {
                spacing: Theme.spacing-sm;

                LabeledInput {
                    label: "Transfer Code";
                    placeholder: "e.g. 7-alpha-beta-gamma";
                    value <=> code;
                }

                HorizontalBox {
                    Rectangle { horizontal-stretch: 1; }

                    CompactButton {
                        label: "Receive";
                        primary: true;
                        enabled: code != "";
                        clicked => {
                            AppLogic.start-receive(code);
                            code = "";
                        }
                    }
                }
            }
        }

        Rectangle { vertical-stretch: 1; }
    }
}

// ============================================================================
// Peers Panel
// ============================================================================

component PeerCard inherits Rectangle {
    in property <PeerItem> peer;
    callback remove-clicked();
    callback push-clicked();
    callback browse-clicked();

    height: 56px;
    background: Theme.bg-card;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;

    HorizontalLayout {
        padding: Theme.spacing-sm;
        spacing: Theme.spacing-sm;

        // Status indicator
        Rectangle {
            width: 8px;
            height: 8px;
            y: (parent.height - self.height) / 2;
            border-radius: 4px;
            background: peer.status == "online" ? Theme.success :
                       peer.status == "connecting" ? Theme.warning : Theme.text-muted;
        }

        // Peer info
        VerticalLayout {
            horizontal-stretch: 1;
            spacing: 2px;

            Text {
                text: peer.name;
                font-size: 13px;
                color: Theme.text;
                overflow: elide;
            }

            Text {
                text: peer.endpoint-id;
                font-size: 11px;
                font-family: "monospace";
                color: Theme.text-dim;
                overflow: elide;
            }
        }

        // Last seen
        Text {
            text: peer.last-seen;
            font-size: 11px;
            color: Theme.text-muted;
            vertical-alignment: center;
        }

        // Browse button (for pulling files from peer)
        if peer.can-pull : CompactButton {
            label: "Browse";
            clicked => { root.browse-clicked(); }
        }

        // Push button (only show if files selected and peer has permission)
        if peer.can-push && AppLogic.selected-files.length > 0 : CompactButton {
            label: "Push";
            clicked => { root.push-clicked(); }
        }

        // Remove button
        IconBtn {
            icon: "âœ•";
            icon-color: Theme.text-muted;
            clicked => { root.remove-clicked(); }
        }
    }
}

component PeersPanel inherits Rectangle {
    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        // Header with Add Peer button
        HorizontalLayout {
            spacing: Theme.spacing-sm;

            Text {
                text: "Trusted Peers";
                font-size: 14px;
                font-weight: 600;
                color: Theme.text;
                vertical-alignment: center;
                horizontal-stretch: 1;
            }

            // Show endpoint ID (truncated - done in Rust)
            if AppLogic.endpoint-id != "" : Text {
                text: "ID: " + AppLogic.endpoint-id;
                font-size: 10px;
                font-family: "monospace";
                color: Theme.text-muted;
                vertical-alignment: center;
            }

            CompactButton {
                label: AppLogic.trust-in-progress ? "Cancel" : "Add Peer";
                primary: !AppLogic.trust-in-progress;
                clicked => {
                    if AppLogic.trust-in-progress {
                        AppLogic.cancel-trust();
                    } else {
                        AppLogic.initiate-trust();
                    }
                }
            }
        }

        // Trust in progress section
        if AppLogic.trust-in-progress : Section {
            VerticalBox {
                spacing: Theme.spacing-sm;
                padding: Theme.spacing-sm;

                Text {
                    text: "Share this code with the peer you want to add:";
                    font-size: 12px;
                    color: Theme.text-dim;
                    horizontal-alignment: center;
                }

                if AppLogic.trust-code != "" : HorizontalLayout {
                    alignment: center;
                    spacing: Theme.spacing-sm;

                    Rectangle {
                        background: Theme.bg-hover;
                        border-radius: Theme.radius-sm;
                        height: 36px;
                        width: trust-code-text.preferred-width + 24px;

                        trust-code-text := Text {
                            text: AppLogic.trust-code;
                            font-size: 16px;
                            font-weight: 600;
                            font-family: "monospace";
                            color: Theme.accent;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    CompactButton {
                        label: AppLogic.copied-code == AppLogic.trust-code ? "Copied!" : "Copy";
                        clicked => { AppLogic.copy-code(AppLogic.trust-code); }
                    }
                }

                if AppLogic.trust-code == "" : Text {
                    text: "Generating code...";
                    font-size: 12px;
                    color: Theme.text-muted;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Waiting for peer to connect...";
                    font-size: 11px;
                    color: Theme.text-muted;
                    horizontal-alignment: center;
                }
            }
        }

        // Peers list
        Section {
            vertical-stretch: 1;

            if AppLogic.peers.length == 0 && !AppLogic.trust-in-progress : VerticalBox {
                alignment: center;
                spacing: Theme.spacing-sm;

                Text {
                    text: "No trusted peers yet";
                    font-size: 13px;
                    color: Theme.text-dim;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Click 'Add Peer' to establish a trusted connection";
                    font-size: 11px;
                    color: Theme.text-muted;
                    horizontal-alignment: center;
                }
            }

            if AppLogic.peers.length > 0 : ScrollView {
                VerticalBox {
                    spacing: Theme.spacing-xs;

                    for peer in AppLogic.peers : PeerCard {
                        peer: peer;
                        remove-clicked => { AppLogic.remove-peer(peer.id); }
                        push-clicked => { AppLogic.push-to-peer(peer.id); }
                        browse-clicked => { AppLogic.browse-peer(peer.id); }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Settings Panel
// ============================================================================

component SettingsPanel inherits Rectangle {
    in-out property <string> download-dir: AppLogic.settings.download-dir;
    in-out property <string> relay: AppLogic.settings.default-relay;
    in-out property <int> theme-idx: AppLogic.settings.theme == "light" ? 1 : AppLogic.settings.theme == "dark" ? 2 : 0;
    // Transfer options
    in-out property <int> hash-idx: AppLogic.settings.hash-algorithm == "imohash" ? 1 :
                                     AppLogic.settings.hash-algorithm == "md5" ? 2 : 0;
    in-out property <int> curve-idx: AppLogic.settings.curve == "p256" ? 1 :
                                      AppLogic.settings.curve == "p384" ? 2 :
                                      AppLogic.settings.curve == "p521" ? 3 : 0;
    in-out property <string> throttle: AppLogic.settings.throttle;
    in-out property <bool> no-local: AppLogic.settings.no-local;

    background: Theme.bg-dark;

    ScrollView {
        VerticalBox {
            padding: Theme.spacing-md;
            spacing: Theme.spacing-sm;

            // Downloads
            Section {
                title: "Downloads";

                SettingRow {
                    label: "Save Location";
                    sublabel: download-dir == "" ? "Default system downloads" : download-dir;

                    CompactButton {
                        label: "Browse";
                        clicked => { AppLogic.browse-download-dir(); }
                    }
                }
            }

            // Network
            Section {
                title: "Network";

                SettingRow {
                    label: "Custom Relay";
                    sublabel: "Leave empty for default";

                    LineEdit {
                        width: 160px;
                        text <=> relay;
                        placeholder-text: "relay.example.com";
                        font-size: 12px;
                    }
                }

                SettingRow {
                    label: "Force Relay Only";
                    sublabel: "Disable local network transfers";

                    Rectangle {
                        width: 40px;
                        height: 22px;
                        border-radius: 11px;
                        background: no-local ? Theme.accent : Theme.bg-hover;
                        border-width: 1px;
                        border-color: Theme.border;

                        toggle-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { no-local = !no-local; }
                        }

                        Rectangle {
                            x: no-local ? parent.width - self.width - 2px : 2px;
                            y: 2px;
                            width: 18px;
                            height: 18px;
                            border-radius: 9px;
                            background: #ffffff;

                            animate x { duration: 150ms; easing: ease-out; }
                        }
                    }
                }
            }

            // Transfer Options
            Section {
                title: "Transfer Options";

                SettingRow {
                    label: "Hash Algorithm";
                    sublabel: "File verification method";

                    ComboBox {
                        width: 110px;
                        model: ["xxhash", "imohash", "md5"];
                        current-index <=> hash-idx;
                    }
                }

                SettingRow {
                    label: "Encryption Curve";
                    sublabel: "PAKE elliptic curve";

                    ComboBox {
                        width: 110px;
                        model: ["siec", "p256", "p384", "p521"];
                        current-index <=> curve-idx;
                    }
                }

                SettingRow {
                    label: "Bandwidth Limit";
                    sublabel: "e.g. 1M, 500K (empty = unlimited)";

                    LineEdit {
                        width: 110px;
                        text <=> throttle;
                        placeholder-text: "unlimited";
                        font-size: 12px;
                    }
                }
            }

            // Appearance
            Section {
                title: "Appearance";

                SettingRow {
                    label: "Theme";

                    ComboBox {
                        width: 100px;
                        model: ["System", "Light", "Dark"];
                        current-index <=> theme-idx;
                    }
                }
            }

            // About
            Section {
                title: "About";

                SettingRow {
                    label: "Croc";
                    sublabel: AppLogic.settings.croc-found ? AppLogic.settings.croc-path : "Not found - required for transfers";

                    HorizontalLayout {
                        spacing: 4px;
                        alignment: center;

                        Rectangle {
                            width: 60px;
                            height: 20px;

                            Text {
                                text: AppLogic.settings.croc-found ? "[OK]" : "[Missing]";
                                font-size: 11px;
                                color: AppLogic.settings.croc-found ? Theme.success : Theme.error;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        CompactButton {
                            label: "Refresh";
                            clicked => { AppLogic.refresh-croc(); }
                        }

                        if !AppLogic.settings.croc-found: CompactButton {
                            label: "Install";
                            primary: true;
                            clicked => { AppLogic.install-croc(); }
                        }
                    }
                }

                SettingRow {
                    label: "Version";
                    sublabel: "Croh v0.1.0";

                    CompactButton {
                        label: "Config";
                        clicked => { AppLogic.open-config-folder(); }
                    }
                }
            }

            // Save
            HorizontalBox {
                Rectangle { horizontal-stretch: 1; }

                CompactButton {
                    label: "Save Settings";
                    primary: true;
                    clicked => {
                        AppLogic.save-settings(
                            download-dir,
                            relay,
                            theme-idx == 0 ? "system" : theme-idx == 1 ? "light" : "dark",
                            hash-idx == 0 ? "xxhash" : hash-idx == 1 ? "imohash" : "md5",
                            curve-idx == 0 ? "siec" : curve-idx == 1 ? "p256" : curve-idx == 2 ? "p384" : "p521",
                            throttle,
                            no-local
                        );
                    }
                }
            }
        }
    }
}

// ============================================================================
// Resize Handle (draggable divider)
// ============================================================================

component ResizeHandle inherits Rectangle {
    callback dragged(length);

    height: 6px;
    background: touch.has-hover || touch.pressed ? Theme.border-focus : Theme.border;

    touch := TouchArea {
        mouse-cursor: row-resize;
        moved => {
            if (self.pressed) {
                root.dragged(self.mouse-y);
            }
        }
    }

    // Visual grip indicator
    Rectangle {
        x: (parent.width - 40px) / 2;
        y: 2px;
        width: 40px;
        height: 2px;
        background: touch.has-hover || touch.pressed ? Theme.accent : Theme.text-muted;
        border-radius: 1px;
    }
}

// ============================================================================
// Transfers Panel (bottom bar) - grows with window
// ============================================================================

component TransfersBar inherits Rectangle {
    background: Theme.bg-card;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: 4px;
        spacing: 2px;

        // Header
        Text {
            text: "Transfers (" + AppLogic.transfers.length + ")";
            font-size: 10px;
            color: #888888;
        }

        // Content
        if AppLogic.transfers.length == 0: Text {
            text: "No transfers";
            font-size: 10px;
            color: #aaaaaa;
            horizontal-alignment: center;
            vertical-alignment: center;
            vertical-stretch: 1;
        }

        // Transfer list - scrollable
        if AppLogic.transfers.length > 0: Flickable {
            vertical-stretch: 1;
            viewport-height: AppLogic.transfers.length * 32px;

            VerticalLayout {
                spacing: 2px;

                for transfer in AppLogic.transfers: TransferCard {
                    transfer: transfer;
                }
            }
        }
    }
}

// ============================================================================
// File Browser Entry
// ============================================================================

component BrowseEntryRow inherits Rectangle {
    in property <BrowseEntry> entry;
    in property <int> index;
    callback clicked();
    callback double-clicked();

    height: 28px;
    background: entry.selected ? Theme.accent-glow : (touch.has-hover ? Theme.bg-hover : transparent);
    border-radius: Theme.radius-sm;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
        double-clicked => { root.double-clicked(); }
    }

    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 8px;

        // Icon
        Text {
            text: entry.is-dir ? "ðŸ“" : "ðŸ“„";
            font-size: 14px;
            vertical-alignment: center;
            width: 20px;
        }

        // Name
        Text {
            text: entry.name;
            font-size: 12px;
            color: Theme.text;
            overflow: elide;
            horizontal-stretch: 1;
            vertical-alignment: center;
        }

        // Size (files only)
        if !entry.is-dir: Text {
            text: entry.size;
            font-size: 11px;
            color: Theme.text-muted;
            vertical-alignment: center;
            width: 70px;
            horizontal-alignment: right;
        }

        // Selection indicator (files only)
        if !entry.is-dir: Rectangle {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border-width: 1px;
            border-color: entry.selected ? Theme.accent : Theme.border;
            background: entry.selected ? Theme.accent : transparent;

            Text {
                text: entry.selected ? "âœ“" : "";
                font-size: 12px;
                color: Theme.accent-text;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

// ============================================================================
// File Browser Dialog
// ============================================================================

component FileBrowserDialog inherits Rectangle {
    background: #00000080;

    // Click outside to close
    touch := TouchArea {
        clicked => { AppLogic.browse-close(); }
    }

    // Dialog panel
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: min(parent.width - 40px, 600px);
        height: min(parent.height - 60px, 500px);
        background: Theme.bg-card;
        border-radius: Theme.radius-md;
        border-width: 1px;
        border-color: Theme.border;

        // Prevent clicks from closing
        TouchArea {}

        VerticalLayout {
            padding: 0;
            spacing: 0;

            // Header
            Rectangle {
                height: 44px;
                background: Theme.bg-dark;
                border-radius: Theme.radius-md;

                HorizontalLayout {
                    padding: Theme.spacing-sm;
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "Browse: " + AppLogic.browse-peer-name;
                        font-size: 14px;
                        font-weight: 600;
                        color: Theme.text;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    IconBtn {
                        icon: "âœ•";
                        icon-color: Theme.text-muted;
                        clicked => { AppLogic.browse-close(); }
                    }
                }
            }

            // Breadcrumb / Path
            Rectangle {
                height: 36px;
                background: Theme.bg-hover;

                HorizontalLayout {
                    padding-left: Theme.spacing-sm;
                    padding-right: Theme.spacing-sm;
                    spacing: Theme.spacing-xs;

                    // Up button
                    CompactButton {
                        label: "â†‘ Up";
                        enabled: AppLogic.browse-current-path != "/";
                        clicked => {
                            // Navigate to parent
                            AppLogic.browse-navigate("..");
                        }
                    }

                    // Current path
                    Text {
                        text: AppLogic.browse-current-path;
                        font-size: 12px;
                        font-family: "monospace";
                        color: Theme.text-dim;
                        overflow: elide;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }
                }
            }

            // Content area
            Rectangle {
                vertical-stretch: 1;
                background: Theme.bg-card;

                // Loading indicator
                if AppLogic.browse-loading: VerticalLayout {
                    alignment: center;
                    Text {
                        text: "Loading...";
                        font-size: 13px;
                        color: Theme.text-muted;
                        horizontal-alignment: center;
                    }
                }

                // Error message
                if AppLogic.browse-error != "" && !AppLogic.browse-loading: VerticalLayout {
                    alignment: center;
                    padding: Theme.spacing-md;

                    Text {
                        text: "Error";
                        font-size: 14px;
                        font-weight: 600;
                        color: Theme.error;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: AppLogic.browse-error;
                        font-size: 12px;
                        color: Theme.text-dim;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                    }
                }

                // File list
                if !AppLogic.browse-loading && AppLogic.browse-error == "": ScrollView {
                    VerticalLayout {
                        padding: Theme.spacing-xs;
                        spacing: 2px;

                        if AppLogic.browse-entries.length == 0: Text {
                            text: "No files found";
                            font-size: 12px;
                            color: Theme.text-muted;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        for entry[i] in AppLogic.browse-entries: BrowseEntryRow {
                            entry: entry;
                            index: i;
                            clicked => {
                                if entry.is-dir {
                                    // Navigate into directory
                                    AppLogic.browse-navigate(entry.path);
                                } else {
                                    // Toggle selection
                                    AppLogic.browse-toggle-select(i);
                                }
                            }
                            double-clicked => {
                                if entry.is-dir {
                                    AppLogic.browse-navigate(entry.path);
                                }
                            }
                        }
                    }
                }
            }

            // Footer with actions
            Rectangle {
                height: 50px;
                background: Theme.bg-dark;

                HorizontalLayout {
                    padding: Theme.spacing-sm;
                    spacing: Theme.spacing-sm;

                    // Selection hint
                    Text {
                        text: "Click files to select, then pull";
                        font-size: 12px;
                        color: Theme.text-dim;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    CompactButton {
                        label: "Cancel";
                        clicked => { AppLogic.browse-close(); }
                    }

                    CompactButton {
                        label: "Pull Selected";
                        primary: true;
                        clicked => { AppLogic.browse-pull-selected(); }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Main Window
// ============================================================================

export component MainWindow inherits Window {
    title: "Croh";
    min-width: 480px;
    min-height: 400px;
    preferred-width: 600px;
    preferred-height: 500px;
    background: Theme.bg-dark;

    property <int> active-tab: 0;
    property <length> transfers-height: 150px;

    VerticalLayout {
        spacing: 0;

        // Header
        Rectangle {
            height: 40px;
            background: Theme.bg-card;
            border-width: 1px;
            border-color: Theme.border;

            HorizontalLayout {
                padding: 8px;
                padding-left: 12px;
                padding-right: 12px;
                alignment: space-between;

                Text {
                    text: "Croh";
                    font-size: 14px;
                    color: Theme.text;
                    vertical-alignment: center;
                }

                Text {
                    text: AppLogic.app-status;
                    font-size: 11px;
                    color: Theme.text-dim;
                    vertical-alignment: center;
                }
            }
        }

        // Tabs
        Rectangle {
            height: 40px;
            background: Theme.bg-dark;

            HorizontalLayout {
                padding: 4px;
                padding-left: 8px;
                padding-right: 8px;

                PillTabs {
                    tabs: ["Send", "Receive", "Peers", "Settings"];
                    current <=> active-tab;
                }
            }
        }

        // Content - stretches to fill remaining space
        Rectangle {
            vertical-stretch: 1;

            if active-tab == 0: SendPanel {}
            if active-tab == 1: ReceivePanel {}
            if active-tab == 2: PeersPanel {}
            if active-tab == 3: SettingsPanel {}
        }

        // Resize handle
        ResizeHandle {
            dragged(delta) => {
                // Subtract delta to resize (dragging up = larger transfers pane)
                transfers-height = clamp(transfers-height - delta, 60px, 400px);
            }
        }

        // Transfers bar - user-resizable height
        TransfersBar {
            height: transfers-height;
        }
    }

    // File browser overlay
    if AppLogic.browse-open: FileBrowserDialog {}
}
