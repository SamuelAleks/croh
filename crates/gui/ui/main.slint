import { Button, VerticalBox, HorizontalBox, TabWidget, ProgressIndicator, ScrollView } from "std-widgets.slint";

// ============================================================================
// Theme Colors - Reactive to AppLogic.settings.theme
// ============================================================================
// Supported themes: system, light, dark, dracula, nord, solarized-dark,
//                   solarized-light, gruvbox-dark, gruvbox-light,
//                   catppuccin-mocha, catppuccin-latte

global Theme {
    property <string> theme: AppLogic.settings.theme;

    // Core background colors
    out property <color> bg-dark:
        theme == "light" ? #f5f5f5 :
        theme == "dracula" ? #282a36 :
        theme == "nord" ? #2e3440 :
        theme == "solarized-dark" ? #002b36 :
        theme == "solarized-light" ? #fdf6e3 :
        theme == "gruvbox-dark" ? #282828 :
        theme == "gruvbox-light" ? #fbf1c7 :
        theme == "catppuccin-mocha" ? #1e1e2e :
        theme == "catppuccin-latte" ? #eff1f5 :
        #1e1e1e; // dark (default)

    out property <color> bg-card:
        theme == "light" ? #ffffff :
        theme == "dracula" ? #44475a :
        theme == "nord" ? #3b4252 :
        theme == "solarized-dark" ? #073642 :
        theme == "solarized-light" ? #eee8d5 :
        theme == "gruvbox-dark" ? #3c3836 :
        theme == "gruvbox-light" ? #ebdbb2 :
        theme == "catppuccin-mocha" ? #313244 :
        theme == "catppuccin-latte" ? #e6e9ef :
        #2d2d2d;

    out property <color> bg-hover:
        theme == "light" ? #e8e8e8 :
        theme == "dracula" ? #6272a4 :
        theme == "nord" ? #434c5e :
        theme == "solarized-dark" ? #094959 :
        theme == "solarized-light" ? #d6ceb5 :
        theme == "gruvbox-dark" ? #504945 :
        theme == "gruvbox-light" ? #d5c4a1 :
        theme == "catppuccin-mocha" ? #45475a :
        theme == "catppuccin-latte" ? #ccd0da :
        #3d3d3d;

    out property <color> bg-input:
        theme == "light" ? #585858 :
        theme == "dracula" ? #6272a4 :
        theme == "nord" ? #4c566a :
        theme == "solarized-dark" ? #586e75 :
        theme == "solarized-light" ? #93a1a1 :
        theme == "gruvbox-dark" ? #665c54 :
        theme == "gruvbox-light" ? #a89984 :
        theme == "catppuccin-mocha" ? #585b70 :
        theme == "catppuccin-latte" ? #9ca0b0 :
        #404040;

    // Border & outline
    out property <color> border:
        theme == "light" ? #cccccc :
        theme == "dracula" ? #6272a4 :
        theme == "nord" ? #4c566a :
        theme == "solarized-dark" ? #586e75 :
        theme == "solarized-light" ? #93a1a1 :
        theme == "gruvbox-dark" ? #504945 :
        theme == "gruvbox-light" ? #bdae93 :
        theme == "catppuccin-mocha" ? #45475a :
        theme == "catppuccin-latte" ? #bcc0cc :
        #4d4d4d;

    out property <color> border-focus:
        theme == "dracula" ? #bd93f9 :
        theme == "nord" ? #88c0d0 :
        theme == "solarized-dark" ? #268bd2 :
        theme == "solarized-light" ? #268bd2 :
        theme == "gruvbox-dark" ? #fabd2f :
        theme == "gruvbox-light" ? #d79921 :
        theme == "catppuccin-mocha" ? #cba6f7 :
        theme == "catppuccin-latte" ? #8839ef :
        #0066cc;

    // Text colors
    out property <color> text:
        theme == "light" ? #222222 :
        theme == "dracula" ? #f8f8f2 :
        theme == "nord" ? #eceff4 :
        theme == "solarized-dark" ? #839496 :
        theme == "solarized-light" ? #657b83 :
        theme == "gruvbox-dark" ? #ebdbb2 :
        theme == "gruvbox-light" ? #3c3836 :
        theme == "catppuccin-mocha" ? #cdd6f4 :
        theme == "catppuccin-latte" ? #4c4f69 :
        #e0e0e0;

    out property <color> text-dim:
        theme == "light" ? #303030 :
        theme == "dracula" ? #f8f8f2 :
        theme == "nord" ? #d8dee9 :
        theme == "solarized-dark" ? #93a1a1 :
        theme == "solarized-light" ? #586e75 :
        theme == "gruvbox-dark" ? #d5c4a1 :
        theme == "gruvbox-light" ? #504945 :
        theme == "catppuccin-mocha" ? #bac2de :
        theme == "catppuccin-latte" ? #5c5f77 :
        #b0b0b0;

    out property <color> text-muted:
        theme == "light" ? #999999 :
        theme == "dracula" ? #6272a4 :
        theme == "nord" ? #81a1c1 :
        theme == "solarized-dark" ? #586e75 :
        theme == "solarized-light" ? #93a1a1 :
        theme == "gruvbox-dark" ? #928374 :
        theme == "gruvbox-light" ? #7c6f64 :
        theme == "catppuccin-mocha" ? #6c7086 :
        theme == "catppuccin-latte" ? #9ca0b0 :
        #808080;

    // Accent colors
    out property <color> accent:
        theme == "dracula" ? #bd93f9 :
        theme == "nord" ? #88c0d0 :
        theme == "solarized-dark" ? #268bd2 :
        theme == "solarized-light" ? #268bd2 :
        theme == "gruvbox-dark" ? #fabd2f :
        theme == "gruvbox-light" ? #d79921 :
        theme == "catppuccin-mocha" ? #cba6f7 :
        theme == "catppuccin-latte" ? #8839ef :
        #0066cc;

    out property <color> accent-glow:
        theme == "dracula" ? #bd93f940 :
        theme == "nord" ? #88c0d040 :
        theme == "solarized-dark" ? #268bd240 :
        theme == "solarized-light" ? #268bd240 :
        theme == "gruvbox-dark" ? #fabd2f40 :
        theme == "gruvbox-light" ? #d7992140 :
        theme == "catppuccin-mocha" ? #cba6f740 :
        theme == "catppuccin-latte" ? #8839ef40 :
        #0066cc40;

    out property <color> accent-text: #ffffff;

    // Status colors
    out property <color> success:
        theme == "dracula" ? #50fa7b :
        theme == "nord" ? #a3be8c :
        theme == "solarized-dark" ? #859900 :
        theme == "solarized-light" ? #859900 :
        theme == "gruvbox-dark" ? #b8bb26 :
        theme == "gruvbox-light" ? #98971a :
        theme == "catppuccin-mocha" ? #a6e3a1 :
        theme == "catppuccin-latte" ? #40a02b :
        #228b22;

    out property <color> error:
        theme == "dracula" ? #ff5555 :
        theme == "nord" ? #bf616a :
        theme == "solarized-dark" ? #dc322f :
        theme == "solarized-light" ? #dc322f :
        theme == "gruvbox-dark" ? #fb4934 :
        theme == "gruvbox-light" ? #cc241d :
        theme == "catppuccin-mocha" ? #f38ba8 :
        theme == "catppuccin-latte" ? #d20f39 :
        #cc0000;

    out property <color> warning:
        theme == "dracula" ? #f1fa8c :
        theme == "nord" ? #ebcb8b :
        theme == "solarized-dark" ? #b58900 :
        theme == "solarized-light" ? #b58900 :
        theme == "gruvbox-dark" ? #fe8019 :
        theme == "gruvbox-light" ? #d65d0e :
        theme == "catppuccin-mocha" ? #fab387 :
        theme == "catppuccin-latte" ? #fe640b :
        #cc8800;

    out property <color> info:
        theme == "dracula" ? #8be9fd :
        theme == "nord" ? #81a1c1 :
        theme == "solarized-dark" ? #2aa198 :
        theme == "solarized-light" ? #2aa198 :
        theme == "gruvbox-dark" ? #83a598 :
        theme == "gruvbox-light" ? #458588 :
        theme == "catppuccin-mocha" ? #89b4fa :
        theme == "catppuccin-latte" ? #1e66f5 :
        #0066cc;

    // Transfer type colors
    out property <color> send-color:
        theme == "dracula" ? #50fa7b :
        theme == "nord" ? #a3be8c :
        theme == "solarized-dark" ? #859900 :
        theme == "solarized-light" ? #859900 :
        theme == "gruvbox-dark" ? #b8bb26 :
        theme == "gruvbox-light" ? #98971a :
        theme == "catppuccin-mocha" ? #a6e3a1 :
        theme == "catppuccin-latte" ? #40a02b :
        #228b22;

    out property <color> receive-color:
        theme == "dracula" ? #8be9fd :
        theme == "nord" ? #81a1c1 :
        theme == "solarized-dark" ? #268bd2 :
        theme == "solarized-light" ? #268bd2 :
        theme == "gruvbox-dark" ? #83a598 :
        theme == "gruvbox-light" ? #458588 :
        theme == "catppuccin-mocha" ? #89b4fa :
        theme == "catppuccin-latte" ? #1e66f5 :
        #0066cc;

    // Sizing
    out property <length> radius-sm: 4px;
    out property <length> radius-md: 4px;
    out property <length> radius-lg: 4px;
    out property <length> spacing-xs: 4px;
    out property <length> spacing-sm: 8px;
    out property <length> spacing-md: 12px;
    out property <length> spacing-lg: 16px;
}

// ============================================================================
// Icons - SVG icon assets for consistent cross-platform rendering
// ============================================================================

global Icons {
    out property <image> folder: @image-url("../assets/icons/folder.svg");
    out property <image> file: @image-url("../assets/icons/file.svg");
    out property <image> chevron-down: @image-url("../assets/icons/chevron-down.svg");
    out property <image> chevron-up: @image-url("../assets/icons/chevron-up.svg");
    out property <image> x: @image-url("../assets/icons/x.svg");
    out property <image> check: @image-url("../assets/icons/check.svg");
    // Status icons
    out property <image> signal: @image-url("../assets/icons/signal.svg");
    out property <image> arrow-up: @image-url("../assets/icons/arrow-up.svg");
    out property <image> arrow-down: @image-url("../assets/icons/arrow-down.svg");
    out property <image> clock: @image-url("../assets/icons/clock.svg");
    out property <image> users: @image-url("../assets/icons/users.svg");
    out property <image> hard-drive: @image-url("../assets/icons/hard-drive.svg");
    out property <image> activity: @image-url("../assets/icons/activity.svg");
    out property <image> zap: @image-url("../assets/icons/zap.svg");
}

// ============================================================================
// Data Structures
// ============================================================================

export struct TransferItem {
    id: string,
    transfer-type: string,
    status: string,
    code: string,
    files: string,
    progress: float,
    speed: string,
    error: string,
    // Enhanced stats
    total-size: string,       // "5.2 GB"
    transferred-size: string, // "2.1 GB"
    elapsed: string,          // "2:34"
    eta: string,              // "~3:45" or ""
}

export struct SelectedFile {
    name: string,
    size: string,
    path: string,
}

export struct AppSettings {
    download-dir: string,
    default-relay: string,
    theme: string,
    croc-path: string,
    croc-found: bool,
    // Device identity
    device-nickname: string,      // user-configurable display name (empty = use hostname)
    device-hostname: string,      // actual hostname (read-only, for display)
    // Transfer options
    hash-algorithm: string,  // "xxhash", "imohash", "md5", or "" for default
    curve: string,           // "siec", "p256", "p384", "p521", or "" for default
    throttle: string,        // bandwidth limit e.g. "1M", "500K", or "" for unlimited
    no-local: bool,          // force relay-only transfers
    // Browse settings
    browse-show-hidden: bool,     // show hidden files (starting with .)
    browse-show-protected: bool,  // show protected system dirs (.ssh, .gnupg, etc.)
    browse-exclude-patterns: string,  // comma-separated exclude patterns
    // Do Not Disturb settings
    dnd-mode: string,        // "off", "silent", "busy"
    dnd-message: string,     // custom status message
    // Privacy settings
    show-session-stats: bool,     // show upload/download totals in header
    // Transfer list settings
    keep-completed-transfers: bool,  // keep completed transfers in list (vs auto-clear)
    // Security settings
    security-posture: string,     // "relaxed", "balanced", "cautious"
}

export struct PeerItem {
    id: string,
    name: string,
    endpoint-id: string,
    status: string,          // "online", "offline", "connecting"
    last-seen: string,
    relay-url: string,       // relay URL for connectivity
    added-at: string,        // when peer was added
    expanded: bool,          // UI state: whether details panel is expanded
    // Permissions THEY grant to US (what we can do to them)
    can-push: bool,          // we can push files to this peer
    can-pull: bool,          // we can pull files from this peer
    can-browse: bool,        // we can browse this peer's filesystem
    // Permissions WE grant to THEM (what they can do to us)
    allow-push: bool,        // they can push files to us
    allow-pull: bool,        // they can pull files from us
    allow-browse: bool,      // they can browse our filesystem
    // Connection status details
    latency-ms: int,              // current ping latency (-1 if unknown)
    avg-latency-ms: int,          // rolling average latency
    connection-type: string,      // "direct", "relay", "unknown"
    last-contact: string,         // formatted relative time "Just now", "5 min ago"
    ping-count: int,              // number of successful pings
    last-upload-speed: string,    // last transfer upload speed
    last-download-speed: string,  // last transfer download speed
    // Remote peer info (from StatusResponse)
    peer-hostname: string,
    peer-os: string,
    peer-version: string,
    peer-free-space: string,      // formatted "50.2 GB"
    peer-total-space: string,     // formatted "500 GB"
    peer-storage-percent: int,    // 0-100 (percent free)
    peer-uptime: string,          // formatted "2d 5h"
    peer-active-transfers: int,   // how many transfers peer is doing
    // Peer's DND status
    peer-dnd-mode: string,        // "off", "silent", "busy"
    peer-dnd-message: string,     // their custom status message
    // Speed test results
    speed-test-running: bool,     // true while speed test is in progress
    speed-test-upload: string,    // formatted upload speed e.g. "12.5 MB/s"
    speed-test-download: string,  // formatted download speed e.g. "10.2 MB/s"
    speed-test-latency: string,   // formatted latency e.g. "45 ms"
    // Connection control
    connected: bool,              // false = user disconnected, skip pings and block connections
    revoked: bool,                // true = remote peer revoked our trust (grayed out, only remove works)
    // Guest peer fields
    is-guest: bool,               // true = temporary guest peer
    expires-at: string,           // formatted expiry time (empty if not a guest)
    time-remaining: string,       // formatted countdown "2h 30m" or "Expired"
    extension-count: int,         // how many times guest was extended
    promotion-pending: bool,      // guest has requested promotion
}

export struct BrowseEntry {
    name: string,
    is-dir: bool,
    size: string,
    modified: string,
    path: string,            // full path for selection
    selected: bool,
}

export struct SessionStats {
    total-uploaded: string,      // "1.2 GB"
    total-downloaded: string,    // "3.4 GB"
    transfer-count: int,         // completed this session
    avg-speed: string,           // "12.5 MB/s"
    session-duration: string,    // "2h 34m"
}

// Member info for network display
export struct NetworkMember {
    peer-id: string,             // peer store ID
    name: string,                // display name
}

export struct NetworkItem {
    id: string,
    name: string,
    description: string,
    member-count: int,
    is-owner: bool,              // true if we created/own this network
    allow-introductions: bool,   // whether introductions are enabled
    created-at: string,          // formatted date
    members: [NetworkMember],    // list of members in this network
}

// ============================================================================
// Application Logic Interface
// ============================================================================

export global AppLogic {
    callback browse-files();
    callback clear-files();
    callback remove-file(int);
    callback start-send(string);  // custom code phrase (empty = auto-generate)
    callback start-receive(string);
    callback cancel-transfer(string);
    callback remove-transfer(string);
    callback copy-code(string);
    callback open-folder(string);
    callback browse-download-dir();
    // save-settings: download-dir, relay, theme, hash, curve, throttle, no-local
    callback save-settings(string, string, string, string, string, string, bool);
    callback open-config-folder();
    callback refresh-croc();
    callback install-croc();
    callback set-theme(string);  // live theme change: "system", "light", "dark"
    // auto-save-settings: download-dir, relay, theme, hash, curve, throttle, no-local
    callback auto-save-settings(string, string, string, string, string, string, bool);
    // save-browse-settings: show-hidden, show-protected, exclude-patterns
    callback save-browse-settings(bool, bool, string);
    // set-dnd-mode: mode ("off", "silent", "busy"), message
    callback set-dnd-mode(string, string);
    // set-security-posture: posture ("relaxed", "balanced", "cautious")
    callback set-security-posture(string);
    // set-device-nickname: nickname (empty = use hostname)
    callback set-device-nickname(string);

    // Trusted peers callbacks
    // guest-mode: true to add peer as temporary guest, false for full trust
    callback initiate-trust(bool);  // guest_mode
    callback cancel-trust();
    // Toggle for the UI to show guest mode option
    in-out property <bool> add-peer-as-guest: false;
    // Guest duration in hours (0 = use default from config)
    in-out property <int> guest-duration-hours: 0;
    callback remove-peer(string);  // peer id
    callback rename-peer(string, string);  // peer id, new name
    callback disconnect-peer(string);  // peer id - pause connections to/from peer
    callback connect-peer(string);     // peer id - resume connections to/from peer
    callback push-to-peer(string); // peer id - push selected files to peer
    callback pull-from-peer(string); // peer id - open browse dialog for peer
    // peer id, allow-push, allow-pull, allow-browse
    callback update-peer-permissions(string, bool, bool, bool);
    // peer id, expanded state
    callback set-peer-expanded(string, bool);
    // Refresh peer status (trigger immediate ping)
    callback refresh-peer-status(string);  // peer id
    // Run speed test with peer
    callback run-speed-test(string);  // peer id

    // Guest peer management callbacks
    callback extend-guest(string);     // peer id - extend guest's access time
    callback promote-guest(string);    // peer id - promote guest to trusted peer

    // Network management callbacks
    callback create-network(string, string);  // name, description
    callback delete-network(string);          // network id
    callback rename-network(string, string);  // network id, new name
    callback add-peer-to-network(string, string);     // network id, peer id
    callback remove-peer-from-network(string, string); // network id, peer id
    callback introduce-peers(string, string, string); // network id, peer1 id, peer2 id

    // File browser callbacks (for remote peer browsing)
    callback browse-peer(string);              // peer id - start browsing
    callback browse-navigate(string);          // path - navigate to directory
    callback browse-toggle-select(int);        // index - toggle file selection
    callback browse-range-select(int);         // index - select range from last-selected to this index
    callback browse-pull-selected();           // pull all selected files
    callback browse-close();                   // close browser dialog

    in property <[SelectedFile]> selected-files: [];
    in property <[TransferItem]> transfers: [];
    in property <string> app-status: "Ready";
    in property <string> copied-code: "";
    in property <AppSettings> settings: {
        download-dir: "",
        default-relay: "",
        theme: "dark",
        croc-path: "",
        croc-found: false,
        hash-algorithm: "",
        curve: "",
        throttle: "",
        no-local: false,
        browse-show-hidden: false,
        browse-show-protected: false,
        browse-exclude-patterns: "",
    };

    // Trusted peers state
    in property <[PeerItem]> peers: [];
    in property <bool> trust-in-progress: false;
    in property <string> trust-code: "";
    in property <string> endpoint-id: "";

    // Networks state
    in property <[NetworkItem]> networks: [];

    // Push-to-peer helpers (names and IDs of peers that allow push)
    in property <[string]> peer-names-for-push: [];
    in property <[string]> pushable-peer-ids: [];

    // File browser state
    in property <bool> browse-open: false;
    in property <string> browse-peer-id: "";
    in property <string> browse-peer-name: "";
    in property <string> browse-current-path: "/";
    in property <string> browse-previous-path: "";  // For "Go Back" when errors occur
    in property <[BrowseEntry]> browse-entries: [];
    in property <bool> browse-loading: false;
    in property <string> browse-error: "";
    in property <int> browse-selected-count: 0;  // Count of selected files
    in-out property <int> browse-last-selected-index: -1;  // For shift+click range selection

    // Status bar stats
    in property <int> online-peer-count: 0;
    in property <int> total-peer-count: 0;
    in property <int> active-transfer-count: 0;
    in property <SessionStats> session-stats: {
        total-uploaded: "0 B",
        total-downloaded: "0 B",
        transfer-count: 0,
        avg-speed: "",
        session-duration: "",
    };

    // Session stats toggle
    callback toggle-session-stats();
    // Transfer list setting
    callback toggle-keep-completed-transfers();
}

// ============================================================================
// Compact Button
// ============================================================================

component CompactButton inherits Rectangle {
    in property <string> label;
    in property <bool> primary: false;
    in property <bool> enabled: true;
    in property <bool> small: false;
    callback clicked();

    height: small ? 20px : 28px;
    min-width: small ? 50px : 60px;
    horizontal-stretch: 0;
    border-radius: Theme.radius-sm;
    background: !enabled ? Theme.bg-hover :
                primary ? Theme.accent :
                touch.has-hover ? Theme.bg-hover : Theme.bg-card;
    border-width: primary ? 0 : 1px;
    border-color: Theme.border;
    opacity: enabled ? 1.0 : 0.5;

    touch := TouchArea {
        mouse-cursor: enabled ? pointer : default;
        clicked => { if (enabled) { root.clicked(); } }
    }

    HorizontalLayout {
        padding-left: small ? 6px : 10px;
        padding-right: small ? 6px : 10px;

        Text {
            text: label;
            font-size: small ? 10px : 12px;
            color: primary ? #ffffff : Theme.text;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

// ============================================================================
// Icon Button - Uses SVG icons for consistent cross-platform rendering
// ============================================================================

component ImageIconBtn inherits Rectangle {
    in property <image> icon;
    in property <color> icon-color: Theme.text-dim;
    in property <length> icon-size: 14px;
    in property <bool> small: false;
    callback clicked();

    width: small ? 20px : 28px;
    height: small ? 20px : 28px;
    border-radius: Theme.radius-sm;
    background: touch.has-hover ? Theme.bg-hover : transparent;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    Image {
        source: icon;
        width: icon-size;
        height: icon-size;
        colorize: touch.has-hover ? Theme.text : icon-color;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ============================================================================
// Stat Badge - Compact stat display with icon
// ============================================================================

component StatBadge inherits Rectangle {
    in property <image> icon;
    in property <string> value;
    in property <color> value-color: Theme.text;
    in property <bool> show-icon: true;
    in property <string> tooltip-text: "";

    height: 20px;
    border-radius: 10px;
    background: touch.has-hover && tooltip-text != "" ? Theme.bg-card : Theme.bg-hover;

    touch := TouchArea {
        mouse-cursor: tooltip-text != "" ? help : default;
        // Show tooltip on hover after a brief delay would be ideal,
        // but for simplicity show immediately on hover
        clicked => {
            if (tooltip-text != "") {
                tooltip-popup.show();
            }
        }
    }

    // Tooltip popup (always exists, shown on click if text provided)
    tooltip-popup := PopupWindow {
        x: (parent.width - 140px) / 2;
        y: parent.height + 4px;
        width: 140px;

        Rectangle {
            background: Theme.bg-card;
            border-radius: 4px;
            border-width: 1px;
            border-color: Theme.border;
            drop-shadow-blur: 4px;
            drop-shadow-color: #00000040;

            HorizontalLayout {
                padding: 6px;

                Text {
                    text: tooltip-text;
                    font-size: 11px;
                    color: Theme.text;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    wrap: word-wrap;
                }
            }
        }
    }

    HorizontalLayout {
        padding-left: show-icon ? 5px : 8px;
        padding-right: 8px;
        spacing: 4px;
        alignment: center;

        if show-icon: VerticalLayout {
            alignment: center;
            Image {
                source: icon;
                width: 12px;
                height: 12px;
                colorize: value-color;
            }
        }

        Text {
            text: value;
            font-size: 11px;
            color: value-color;
            vertical-alignment: center;
        }
    }
}

// ============================================================================
// Storage Bar - Visual storage usage indicator
// ============================================================================

component StorageBar inherits Rectangle {
    in property <int> percent;        // 0-100 (percent FREE)
    in property <string> free-text;   // "412 GB"
    in property <string> total-text;  // "500 GB"

    height: 20px;
    border-radius: 4px;
    background: Theme.bg-hover;
    border-width: 1px;
    border-color: Theme.border;

    // Progress bar (shows used space, colored by how full)
    Rectangle {
        x: 0;
        y: 0;
        width: parent.width * ((100 - percent) / 100.0);
        height: parent.height;
        border-radius: 4px;
        background: percent > 20 ? Theme.success :
                   percent > 10 ? Theme.warning : Theme.error;
        opacity: 0.3;
    }

    // Text overlay
    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;

        Text {
            text: free-text + " free";
            font-size: 10px;
            color: Theme.text;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }

        Text {
            text: total-text;
            font-size: 10px;
            color: Theme.text-muted;
            vertical-alignment: center;
        }
    }
}

// ============================================================================
// Themed Dropdown (custom styled ComboBox alternative)
// ============================================================================

component ThemedDropdown inherits Rectangle {
    in property <[string]> model;
    in-out property <int> current-index: 0;
    in property <length> dropdown-width: 100px;
    callback changed(int);

    width: dropdown-width;
    height: 28px;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;
    background: Theme.bg-card;

    // Main button
    HorizontalLayout {
        padding-left: 10px;
        padding-right: 8px;
        spacing: 6px;

        Text {
            text: model[current-index];
            font-size: 12px;
            color: Theme.text;
            vertical-alignment: center;
            horizontal-stretch: 1;
            overflow: elide;
        }

        Image {
            source: Icons.chevron-down;
            width: 12px;
            height: 12px;
            colorize: Theme.text-muted;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { popup.show(); }
    }

    // Dropdown popup using PopupWindow for proper z-ordering
    popup := PopupWindow {
        x: 0;
        y: root.height;
        width: root.width;

        Rectangle {
            background: Theme.bg-card;
            border-radius: Theme.radius-sm;
            border-width: 1px;
            border-color: Theme.border;

            VerticalLayout {
                for item[i] in model: Rectangle {
                    height: 28px;
                    background: item-touch.has-hover ? Theme.bg-hover : transparent;

                    item-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            current-index = i;
                            popup.close();
                            root.changed(i);
                        }
                    }

                    HorizontalLayout {
                        padding-left: 10px;
                        padding-right: 10px;

                        Text {
                            text: item;
                            font-size: 12px;
                            color: i == current-index ? Theme.accent : Theme.text;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Themed Text Input
// ============================================================================

component ThemedInput inherits Rectangle {
    in-out property <string> text;
    in property <string> placeholder-text: "";
    in property <length> font-size: 12px;
    in property <length> input-width: 100px;
    callback edited();  // Called when text editing is complete (on blur)

    width: input-width;
    height: 28px;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: input.has-focus ? Theme.border-focus : Theme.border;
    background: Theme.bg-card;

    // Track focus changes to detect blur
    property <bool> currently-focused: input.has-focus;
    property <bool> was-focused: false;
    changed currently-focused => {
        if was-focused && !currently-focused {
            // Lost focus - trigger edited callback
            root.edited();
        }
        was-focused = currently-focused;
    }

    // Scroll offset for the text input (negative = scrolled left)
    property <length> scroll-offset: 0;

    // Clipping container for the input area
    Rectangle {
        x: 8px;
        y: 0;
        width: parent.width - 16px;
        height: parent.height;
        clip: true;

        input := TextInput {
            x: root.scroll-offset;
            width: max(parent.width, self.preferred-width + 20px);
            text <=> root.text;
            font-size: root.font-size;
            color: Theme.text;
            vertical-alignment: center;
            single-line: true;
            accepted => { root.edited(); }

            // Handle cursor movement to implement scrolling
            cursor-position-changed(cursor-pos) => {
                // Visible area width
                // Use a direct calculation based on container
                // cursor-pos.x is relative to the TextInput
                // We need to check if cursor is outside visible area

                // Margin from edges to trigger scroll
                // If cursor goes past right edge of visible area, scroll left
                if cursor-pos.x + root.scroll-offset > parent.width - 4px {
                    root.scroll-offset = parent.width - cursor-pos.x - 4px;
                }
                // If cursor goes past left edge, scroll right
                if cursor-pos.x + root.scroll-offset < 4px {
                    root.scroll-offset = 4px - cursor-pos.x;
                }
                // Don't scroll past the beginning
                if root.scroll-offset > 0 {
                    root.scroll-offset = 0;
                }
            }
        }
    }


    // Placeholder text
    if root.text == "": Text {
        x: 8px;
        text: placeholder-text;
        font-size: root.font-size;
        color: Theme.text-muted;
        vertical-alignment: center;
    }
}

// ============================================================================
// Transfer Card (very compact)
// ============================================================================

component TransferCard inherits Rectangle {
    in property <TransferItem> transfer;

    background: Theme.bg-card;
    border-radius: 3px;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: 6px;
        padding-left: 8px;
        padding-right: 8px;
        spacing: 4px;

        // Single row with all info
        HorizontalLayout {
            spacing: 8px;

            // Direction
            Text {
                text: transfer.transfer-type == "send" ? "↑" : "↓";
                font-size: 11px;
                color: transfer.transfer-type == "send" ? Theme.send-color : Theme.receive-color;
                vertical-alignment: center;
            }

            // Files
            Text {
                text: transfer.files;
                font-size: 11px;
                color: Theme.text;
                overflow: elide;
                horizontal-stretch: 1;
                vertical-alignment: center;
            }

            // Code (if available)
            if transfer.code != "": Rectangle {
                background: Theme.bg-input;
                border-radius: 2px;
                height: 20px;

                code-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => { AppLogic.copy-code(transfer.code); }
                }

                HorizontalLayout {
                    padding-left: 8px;
                    padding-right: 8px;

                    Text {
                        text: transfer.code;
                        font-size: 10px;
                        color: #ffffff;
                        vertical-alignment: center;
                    }
                }
            }

            // Size progress (if running and has size info)
            if transfer.status == "running" && transfer.total-size != "": Text {
                text: transfer.transferred-size + " / " + transfer.total-size;
                font-size: 10px;
                color: Theme.text-dim;
                vertical-alignment: center;
            }

            // Speed (if running and available)
            if transfer.status == "running" && transfer.speed != "": HorizontalLayout {
                spacing: 3px;
                VerticalLayout {
                    alignment: center;
                    Image {
                        source: Icons.zap;
                        width: 10px;
                        height: 10px;
                        colorize: Theme.text-muted;
                    }
                }
                Text {
                    text: transfer.speed;
                    font-size: 10px;
                    color: Theme.text-muted;
                    vertical-alignment: center;
                }
            }

            // Progress % (if running)
            if transfer.status == "running": Text {
                text: Math.round(transfer.progress) + "%";
                font-size: 10px;
                color: transfer.progress > 0 ? Theme.accent : Theme.text-muted;
                vertical-alignment: center;
            }

            // Status indicator
            if transfer.status == "running" || transfer.status == "pending": VerticalLayout {
                alignment: center;
                Rectangle {
                    width: 10px;
                    height: 10px;
                    border-radius: 5px;
                    background: transfer.status == "running" ? Theme.accent : Theme.text-muted;
                }
            }
            if transfer.status == "completed": VerticalLayout {
                alignment: center;
                Image {
                    source: Icons.check;
                    width: 14px;
                    height: 14px;
                    colorize: Theme.success;
                }
            }
            if transfer.status == "failed" || transfer.status == "cancelled": VerticalLayout {
                alignment: center;
                Image {
                    source: Icons.x;
                    width: 12px;
                    height: 12px;
                    colorize: Theme.error;
                }
            }

            // Cancel button (if running)
            if transfer.status == "running": ImageIconBtn {
                icon: Icons.x;
                icon-color: Theme.error;
                clicked => { AppLogic.cancel-transfer(transfer.id); }
            }

            // Remove button (if completed, failed, or cancelled)
            if transfer.status == "completed" || transfer.status == "failed" || transfer.status == "cancelled": ImageIconBtn {
                icon: Icons.x;
                icon-color: Theme.text-muted;
                clicked => { AppLogic.remove-transfer(transfer.id); }
            }
        }

        // Time info row (if running and has elapsed/eta)
        if transfer.status == "running" && (transfer.elapsed != "" || transfer.eta != ""): HorizontalLayout {
            spacing: 12px;

            // Elapsed time
            if transfer.elapsed != "": HorizontalLayout {
                spacing: 3px;
                Image {
                    source: Icons.clock;
                    width: 10px;
                    height: 10px;
                    colorize: Theme.text-muted;
                    vertical-alignment: center;
                }
                Text {
                    text: transfer.elapsed;
                    font-size: 10px;
                    color: Theme.text-muted;
                    vertical-alignment: center;
                }
            }

            Rectangle { horizontal-stretch: 1; }

            // ETA
            if transfer.eta != "": Text {
                text: transfer.eta;
                font-size: 10px;
                color: Theme.text-dim;
                vertical-alignment: center;
            }
        }

        // Progress bar (thin) - always show when running
        if transfer.status == "running": Rectangle {
            height: 3px;
            background: #e0e0e0;
            border-radius: 1px;

            Rectangle {
                x: 0;
                width: transfer.progress > 0 ? parent.width * (transfer.progress / 100.0) : 0;
                height: parent.height;
                background: Theme.accent;
                border-radius: 1px;
            }

            // Indeterminate animation indicator when progress is 0
            if transfer.progress == 0: Rectangle {
                x: mod(animation-tick() / 50ms, parent.width / 1px) * 1px;
                width: 40px;
                height: parent.height;
                background: Theme.accent;
                opacity: 0.5;
                border-radius: 1px;
            }
        }

        // Error (compact)
        if transfer.status == "failed" && transfer.error != "": Text {
            text: transfer.error;
            font-size: 10px;
            color: Theme.error;
            overflow: elide;
        }
    }
}

// ============================================================================
// Drop Zone
// ============================================================================

component DropZone inherits Rectangle {
    callback clicked();

    height: 80px;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;
    background: Theme.bg-card;

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    Text {
        text: "Drop files here or click to browse";
        font-size: 13px;
        color: Theme.text;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ============================================================================
// Setting Row (compact)
// ============================================================================

component SettingRow inherits Rectangle {
    in property <string> label;
    in property <string> sublabel: "";

    height: sublabel == "" ? 36px : 48px;

    HorizontalLayout {
        padding-left: Theme.spacing-sm;
        padding-right: Theme.spacing-sm;
        spacing: Theme.spacing-md;

        // Label section - left aligned, vertically centered
        VerticalLayout {
            horizontal-stretch: 1;
            alignment: center;
            spacing: 2px;

            Text {
                text: label;
                font-size: 13px;
                color: Theme.text;
            }

            if sublabel != "": Text {
                text: sublabel;
                font-size: 11px;
                color: Theme.text-muted;
                overflow: elide;
            }
        }

        // Controls section - right aligned, vertically centered
        VerticalLayout {
            alignment: center;
            @children
        }
    }
}

// ============================================================================
// Section Card
// ============================================================================

component Section inherits Rectangle {
    in property <string> title: "";

    background: Theme.bg-card;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: Theme.spacing-sm;
        spacing: 4px;

        if title != "": Text {
            text: title;
            font-size: 11px;
            font-weight: 500;
            color: Theme.text-muted;
        }

        @children
    }
}

// ============================================================================
// Pill Tab Selector
// ============================================================================

component PillTabs inherits Rectangle {
    in property <[string]> tabs;
    in-out property <int> current: 0;
    callback changed(int);

    height: 32px;
    background: Theme.bg-card;
    border-width: 1px;
    border-color: Theme.border;

    HorizontalBox {
        padding: 2px;
        spacing: 0;

        for tab[i] in tabs: Rectangle {
            horizontal-stretch: 1;
            border-width: 0;
            border-color: Theme.border;
            background: i == current ? Theme.bg-hover : transparent;

            pill-touch := TouchArea {
                mouse-cursor: pointer;
                clicked => {
                    current = i;
                    changed(i);
                }
            }

            Text {
                text: tab;
                font-size: 12px;
                color: i == current ? Theme.text : Theme.text-dim;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

// ============================================================================
// Send Panel
// ============================================================================

component SendPanel inherits Rectangle {
    in-out property <string> custom-code: "";

    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        DropZone {
            clicked => { AppLogic.browse-files(); }
        }

        // Selected files - fixed height based on content
        if AppLogic.selected-files.length > 0: Rectangle {
            background: Theme.bg-card;
            border-radius: Theme.radius-sm;
            border-width: 1px;
            border-color: Theme.border;

            VerticalLayout {
                padding: 6px;
                spacing: 2px;

                Text {
                    text: "Selected (" + AppLogic.selected-files.length + ")";
                    font-size: 11px;
                    color: Theme.text-muted;
                }

                // File list - scrollable when more than 4 items
                Flickable {
                    // Limit height to 4 rows (24px each) + some padding
                    max-height: AppLogic.selected-files.length > 4 ? 100px : AppLogic.selected-files.length * 24px;
                    viewport-height: AppLogic.selected-files.length * 24px;

                    VerticalLayout {
                        for file[i] in AppLogic.selected-files: Rectangle {
                            height: 24px;
                            background: Math.mod(i, 2) == 0 ? Theme.bg-dark : Theme.bg-card;

                            HorizontalLayout {
                                padding-left: 8px;
                                padding-right: 6px;
                                spacing: 8px;

                                Text {
                                    text: file.name;
                                    font-size: 11px;
                                    color: Theme.text;
                                    overflow: elide;
                                    horizontal-stretch: 1;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: file.size;
                                    font-size: 10px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                }

                                ImageIconBtn {
                                    icon: Icons.x;
                                    icon-color: Theme.text-muted;
                                    clicked => { AppLogic.remove-file(i); }
                                }
                            }
                        }
                    }
                }

                // Custom code input (optional)
                HorizontalLayout {
                    spacing: 8px;
                    padding-top: 6px;
                    padding-left: 2px;

                    Text {
                        text: "Code:";
                        font-size: 11px;
                        color: Theme.text-muted;
                        vertical-alignment: center;
                    }

                    ThemedInput {
                        horizontal-stretch: 1;
                        text <=> custom-code;
                        placeholder-text: "auto-generate";
                        font-size: 11px;
                    }
                }

                HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    padding-top: 4px;

                    CompactButton {
                        label: "Clear";
                        clicked => { AppLogic.clear-files(); }
                    }

                    Rectangle { horizontal-stretch: 1; }

                    CompactButton {
                        label: "Send";
                        primary: true;
                        enabled: AppLogic.selected-files.length > 0;
                        clicked => {
                            AppLogic.start-send(custom-code);
                            custom-code = "";
                        }
                    }
                }

                // Push to Peer section - only show if there are peers that allow push
                if AppLogic.peer-names-for-push.length > 0: HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    padding-top: 8px;

                    Text {
                        text: "Push to:";
                        font-size: 11px;
                        color: Theme.text-muted;
                        vertical-alignment: center;
                    }

                    peer-selector := ThemedDropdown {
                        dropdown-width: 140px;
                        model: AppLogic.peer-names-for-push;
                        current-index: 0;
                    }

                    CompactButton {
                        label: "Push";
                        enabled: AppLogic.selected-files.length > 0 && AppLogic.peer-names-for-push.length > 0;
                        clicked => {
                            if (peer-selector.current-index >= 0 && peer-selector.current-index < AppLogic.pushable-peer-ids.length) {
                                AppLogic.push-to-peer(AppLogic.pushable-peer-ids[peer-selector.current-index]);
                            }
                        }
                    }
                }
            }
        }

        // Spacer pushes transfers bar to fill remaining space
        Rectangle {
            vertical-stretch: 1;
            background: transparent;
        }
    }
}

// ============================================================================
// Receive Panel
// ============================================================================

component ReceivePanel inherits Rectangle {
    in-out property <string> code: "";

    background: Theme.bg-dark;

    // Card container with fixed height
    Rectangle {
        x: Theme.spacing-md;
        y: Theme.spacing-md;
        width: parent.width - Theme.spacing-md * 2;
        height: 110px;
        background: Theme.bg-card;
        border-radius: Theme.radius-sm;
        border-width: 1px;
        border-color: Theme.border;

        // Label
        Text {
            x: Theme.spacing-sm;
            y: Theme.spacing-sm;
            text: "Transfer Code";
            font-size: 12px;
            color: Theme.text;
        }

        // Input field
        ThemedInput {
            x: Theme.spacing-sm;
            y: Theme.spacing-sm + 18px;
            text <=> code;
            placeholder-text: "e.g. 7-alpha-beta-gamma";
            font-size: 13px;
            input-width: parent.width - Theme.spacing-sm * 2;
        }

        // Receive button - anchored to right
        HorizontalLayout {
            x: Theme.spacing-sm;
            y: Theme.spacing-sm + 18px + 28px + 8px;
            width: parent.width - Theme.spacing-sm * 2;

            Rectangle { horizontal-stretch: 1; }

            CompactButton {
                label: "Receive";
                primary: true;
                enabled: code != "";
                clicked => {
                    AppLogic.start-receive(code);
                    code = "";
                }
            }
        }
    }
}

// ============================================================================
// Peers Panel
// ============================================================================

// Mini toggle switch component for permissions
component MiniToggle inherits HorizontalLayout {
    in property <bool> checked;
    in property <string> label;
    callback toggled();

    spacing: 4px;
    height: 18px;
    alignment: center;

    Rectangle {
        width: 32px;
        height: 18px;
        border-radius: 9px;
        background: checked ? Theme.accent : Theme.bg-input;
        TouchArea {
            mouse-cursor: pointer;
            clicked => { root.toggled(); }
        }
        Rectangle {
            x: checked ? parent.width - self.width - 2px : 2px;
            y: 2px;
            width: 14px;
            height: 14px;
            border-radius: 7px;
            background: #ffffff;
            animate x { duration: 100ms; }
        }
    }
    Text {
        text: label;
        font-size: 11px;
        color: Theme.text-dim;
        vertical-alignment: center;
    }
}

// Stat box for connection details
component StatBox inherits VerticalLayout {
    in property <string> label;
    in property <string> value;
    in property <color> value-color: Theme.text;

    spacing: 1px;

    Text {
        text: label;
        font-size: 9px;
        color: Theme.text-muted;
    }
    Text {
        text: value;
        font-size: 11px;
        font-weight: 500;
        color: value-color;
    }
}

component PeerCard inherits Rectangle {
    in property <PeerItem> peer;
    in-out property <bool> show-rename: false;
    in-out property <string> rename-text: peer.name;
    callback remove-clicked();
    callback disconnect-clicked();
    callback connect-clicked();
    callback push-clicked();
    callback browse-clicked();
    callback refresh-clicked();
    callback speed-test-clicked();
    callback rename-clicked(string);  // new name
    callback permissions-changed(bool, bool, bool); // allow-push, allow-pull, allow-browse
    callback expanded-changed(bool); // notify when expanded state changes

    background: peer.revoked ? Theme.bg-hover : Theme.bg-card;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: peer.revoked ? Theme.error : (peer.expanded ? Theme.accent : Theme.border);
    opacity: peer.revoked ? 0.7 : 1.0;

    VerticalLayout {
        // Header row (always visible)
        HorizontalLayout {
            height: 56px;
            padding: Theme.spacing-sm;
            spacing: Theme.spacing-sm;

            // Status indicator with pulse animation when online
            Rectangle {
                width: 10px;
                height: 10px;
                y: (parent.height - self.height) / 2;
                border-radius: 5px;
                background: peer.revoked ? Theme.error :
                           peer.status == "online" ? Theme.success :
                           peer.status == "connecting" ? Theme.warning : Theme.text-muted;

                // Ping indicator ring (shows when we have recent latency)
                if peer.status == "online" && peer.latency-ms > 0: Rectangle {
                    x: -2px;
                    y: -2px;
                    width: 14px;
                    height: 14px;
                    border-radius: 7px;
                    border-width: 1px;
                    border-color: Theme.success;
                    opacity: 0.5;
                }
            }

            // Peer info with latency inline
            VerticalLayout {
                horizontal-stretch: 1;
                spacing: 2px;

                HorizontalLayout {
                    spacing: Theme.spacing-sm;

                    Text {
                        text: peer.name;
                        font-size: 13px;
                        color: peer.revoked ? Theme.text-muted : Theme.text;
                        overflow: elide;
                    }

                    // Revoked badge
                    if peer.revoked: Rectangle {
                        width: 60px;
                        height: 16px;
                        border-radius: 3px;
                        background: #ef444430;

                        Text {
                            text: "Revoked";
                            font-size: 10px;
                            color: Theme.error;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Guest badge with time remaining
                    if !peer.revoked && peer.is-guest: Rectangle {
                        width: peer.time-remaining != "" ? 80px : 50px;
                        height: 16px;
                        border-radius: 3px;
                        background: #a855f720;

                        HorizontalLayout {
                            padding-left: 6px;
                            padding-right: 6px;
                            spacing: 4px;

                            Text {
                                text: "Guest";
                                font-size: 10px;
                                color: #a855f7;
                                vertical-alignment: center;
                            }

                            if peer.time-remaining != "": Text {
                                text: peer.time-remaining;
                                font-size: 10px;
                                color: peer.time-remaining == "Expired" ? Theme.error : #a855f7;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Promotion pending badge
                    if !peer.revoked && peer.is-guest && peer.promotion-pending: Rectangle {
                        width: 70px;
                        height: 16px;
                        border-radius: 3px;
                        background: #eab30820;

                        Text {
                            text: "Upgrade?";
                            font-size: 10px;
                            color: Theme.warning;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Inline latency badge when online (not shown when revoked)
                    if !peer.revoked && peer.status == "online" && peer.latency-ms > 0: Rectangle {
                        width: 45px;
                        height: 16px;
                        border-radius: 3px;
                        background: peer.latency-ms < 50 ? #22c55e20 :
                                   peer.latency-ms < 150 ? #eab30820 : #ef444420;

                        Text {
                            text: peer.latency-ms + " ms";
                            font-size: 10px;
                            color: peer.latency-ms < 50 ? Theme.success :
                                  peer.latency-ms < 150 ? Theme.warning : Theme.error;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                HorizontalLayout {
                    spacing: Theme.spacing-sm;

                    Text {
                        text: peer.endpoint-id;
                        font-size: 10px;
                        font-family: "monospace";
                        color: Theme.text-dim;
                        overflow: elide;
                    }
                }
            }

            // Connection type badge
            Rectangle {
                width: 50px;
                height: 20px;
                border-radius: 3px;
                background: peer.connection-type == "direct" ? #22c55e15 :
                           peer.connection-type == "relay" ? #3b82f615 : Theme.bg-hover;

                Text {
                    text: peer.connection-type == "" ? "—" : peer.connection-type;
                    font-size: 10px;
                    color: peer.connection-type == "direct" ? Theme.success :
                          peer.connection-type == "relay" ? Theme.accent : Theme.text-muted;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // DND badge (shows when peer has DND enabled)
            if peer.peer-dnd-mode != "" && peer.peer-dnd-mode != "off": Rectangle {
                width: 36px;
                height: 20px;
                border-radius: 3px;
                background: peer.peer-dnd-mode == "busy" ? #ef444420 : #eab30820;

                Text {
                    text: peer.peer-dnd-mode == "busy" ? "Busy" : "DND";
                    font-size: 10px;
                    color: peer.peer-dnd-mode == "busy" ? Theme.error : Theme.warning;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Browse button (for pulling files from peer) - disabled when revoked
            if !peer.revoked && peer.can-browse && peer.status == "online": CompactButton {
                label: "Browse";
                small: true;
                clicked => { root.browse-clicked(); }
            }

            // Push button (only show if files selected and peer has permission) - disabled when revoked
            if !peer.revoked && peer.can-push && peer.status == "online" && AppLogic.selected-files.length > 0: CompactButton {
                label: "Push";
                small: true;
                clicked => { root.push-clicked(); }
            }

            // Expand/collapse button - disabled when revoked
            if !peer.revoked: ImageIconBtn {
                icon: peer.expanded ? Icons.chevron-up : Icons.chevron-down;
                icon-color: Theme.text-muted;
                small: true;
                clicked => { root.expanded-changed(!peer.expanded); }
            }

            // Remove button (just removes locally, no notification) - always enabled
            ImageIconBtn {
                icon: Icons.x;
                icon-color: peer.revoked ? Theme.error : Theme.text-muted;
                small: true;
                clicked => { root.remove-clicked(); }
            }
        }

        // Expanded details (only visible when expanded and not revoked)
        if peer.expanded && !peer.revoked: Rectangle {
            background: Theme.bg-hover;
            border-radius: Theme.radius-sm;

            VerticalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-sm;

                // Connection status row
                HorizontalLayout {
                    spacing: Theme.spacing-md;
                    height: 36px;

                    StatBox {
                        label: "LATENCY";
                        value: peer.latency-ms > 0 ? peer.latency-ms + " ms" : "—";
                        value-color: peer.latency-ms > 0 ?
                            (peer.latency-ms < 50 ? Theme.success :
                             peer.latency-ms < 150 ? Theme.warning : Theme.error) : Theme.text-muted;
                    }

                    StatBox {
                        label: "AVG LATENCY";
                        value: peer.avg-latency-ms > 0 ? peer.avg-latency-ms + " ms" : "—";
                        value-color: Theme.text-dim;
                    }

                    StatBox {
                        label: "LAST CONTACT";
                        value: peer.last-contact == "" ? "Never" : peer.last-contact;
                        value-color: Theme.text-dim;
                    }

                    StatBox {
                        label: "PINGS";
                        value: peer.ping-count > 0 ? peer.ping-count + "" : "0";
                        value-color: Theme.text-dim;
                    }

                    Rectangle { horizontal-stretch: 1; }

                    // Refresh button
                    CompactButton {
                        label: "↻ Refresh";
                        clicked => { root.refresh-clicked(); }
                    }
                }

                // Transfer speeds row (if we have data)
                if peer.last-upload-speed != "" || peer.last-download-speed != "": HorizontalLayout {
                    spacing: Theme.spacing-md;
                    height: 28px;

                    StatBox {
                        label: "LAST UPLOAD";
                        value: peer.last-upload-speed == "" ? "—" : peer.last-upload-speed;
                        value-color: Theme.accent;
                    }

                    StatBox {
                        label: "LAST DOWNLOAD";
                        value: peer.last-download-speed == "" ? "—" : peer.last-download-speed;
                        value-color: Theme.accent;
                    }
                }

                // Remote peer info row (if we have StatusResponse data)
                if peer.peer-hostname != "" || peer.peer-os != "": HorizontalLayout {
                    spacing: Theme.spacing-md;
                    height: 28px;

                    StatBox {
                        label: "HOSTNAME";
                        value: peer.peer-hostname == "" ? "—" : peer.peer-hostname;
                    }

                    StatBox {
                        label: "OS";
                        value: peer.peer-os == "" ? "—" : peer.peer-os;
                    }

                    StatBox {
                        label: "VERSION";
                        value: peer.peer-version == "" ? "—" : peer.peer-version;
                    }

                    if peer.peer-uptime != "": StatBox {
                        label: "UPTIME";
                        value: peer.peer-uptime;
                        value-color: Theme.text-dim;
                    }

                    if peer.peer-active-transfers > 0: StatBox {
                        label: "BUSY";
                        value: peer.peer-active-transfers + " transfers";
                        value-color: Theme.warning;
                    }
                }

                // Storage bar (if we have space info)
                if peer.peer-free-space != "" && peer.peer-total-space != "": Rectangle {
                    height: 32px;

                    Text {
                        x: 0;
                        y: 0;
                        text: "STORAGE";
                        font-size: 9px;
                        color: Theme.text-muted;
                    }

                    StorageBar {
                        y: 14px;
                        percent: peer.peer-storage-percent;
                        free-text: peer.peer-free-space;
                        total-text: peer.peer-total-space;
                    }
                }

                // Guest info row (only for guest peers)
                if peer.is-guest: HorizontalLayout {
                    spacing: Theme.spacing-md;
                    height: 28px;
                    padding-top: 4px;
                    padding-bottom: 4px;

                    Rectangle {
                        width: 16px;
                        height: 16px;
                        border-radius: 3px;
                        background: #a855f720;
                        y: (parent.height - self.height) / 2;

                        Text {
                            text: "⏱";
                            font-size: 10px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    VerticalLayout {
                        spacing: 2px;

                        Text {
                            text: peer.time-remaining == "Expired" ?
                                  "Guest access has expired" :
                                  "Guest access expires: " + peer.expires-at;
                            font-size: 10px;
                            color: peer.time-remaining == "Expired" ? Theme.error : #a855f7;
                        }

                        if peer.extension-count > 0: Text {
                            text: "Extended " + peer.extension-count + " time" + (peer.extension-count > 1 ? "s" : "");
                            font-size: 9px;
                            color: Theme.text-dim;
                        }
                    }

                    Rectangle { horizontal-stretch: 1; }

                    if peer.time-remaining != "Expired": CompactButton {
                        label: "Extend";
                        clicked => { AppLogic.extend-guest(peer.id); }
                    }

                    CompactButton {
                        label: "Make Trusted";
                        clicked => { AppLogic.promote-guest(peer.id); }
                    }
                }

                // Basic info row
                HorizontalLayout {
                    spacing: Theme.spacing-md;
                    height: 20px;

                    Text {
                        text: "Added: " + peer.added-at;
                        font-size: 10px;
                        color: Theme.text-dim;
                        vertical-alignment: center;
                    }

                    Rectangle { horizontal-stretch: 1; }

                    Text {
                        text: peer.relay-url == "" ? "No relay configured" : "Relay: " + peer.relay-url;
                        font-size: 10px;
                        color: Theme.text-dim;
                        overflow: elide;
                        vertical-alignment: center;
                    }
                }

                // Rename row
                HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    height: 28px;

                    if !show-rename : HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        Text {
                            text: "Name: " + peer.name;
                            font-size: 11px;
                            color: Theme.text-dim;
                            vertical-alignment: center;
                        }

                        Rectangle { horizontal-stretch: 1; }

                        CompactButton {
                            label: "Rename";
                            small: true;
                            clicked => {
                                rename-text = peer.name;
                                show-rename = true;
                            }
                        }
                    }

                    if show-rename : HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        ThemedInput {
                            input-width: 150px;
                            text <=> rename-text;
                            placeholder-text: "New name";
                            font-size: 11px;
                        }

                        CompactButton {
                            label: "Save";
                            small: true;
                            primary: true;
                            enabled: rename-text != "" && rename-text != peer.name;
                            clicked => {
                                root.rename-clicked(rename-text);
                                show-rename = false;
                            }
                        }

                        CompactButton {
                            label: "Cancel";
                            small: true;
                            clicked => {
                                rename-text = peer.name;
                                show-rename = false;
                            }
                        }
                    }
                }

                // Permissions section
                HorizontalLayout {
                    spacing: Theme.spacing-lg;
                    height: 40px;

                    // What we can do (their permissions to us)
                    VerticalLayout {
                        spacing: 2px;

                        Text {
                            text: "They allow us:";
                            font-size: 10px;
                            color: Theme.text-muted;
                        }

                        HorizontalLayout {
                            spacing: Theme.spacing-sm;
                            height: 18px;

                            Text {
                                text: "Push";
                                font-size: 11px;
                                color: peer.can-push ? Theme.success : Theme.text-muted;
                                vertical-alignment: center;
                            }
                            Text {
                                text: "Pull";
                                font-size: 11px;
                                color: peer.can-pull ? Theme.success : Theme.text-muted;
                                vertical-alignment: center;
                            }
                            Text {
                                text: "Browse";
                                font-size: 11px;
                                color: peer.can-browse ? Theme.success : Theme.text-muted;
                                vertical-alignment: center;
                            }
                        }
                    }

                    Rectangle { horizontal-stretch: 1; }

                    // What they can do (our permissions to them)
                    VerticalLayout {
                        spacing: 2px;

                        Text {
                            text: "We allow them:";
                            font-size: 10px;
                            color: Theme.text-muted;
                            horizontal-alignment: right;
                        }

                        HorizontalLayout {
                            spacing: Theme.spacing-sm;
                            height: 18px;

                            MiniToggle {
                                label: "Push";
                                checked: peer.allow-push;
                                toggled => { root.permissions-changed(!peer.allow-push, peer.allow-pull, peer.allow-browse); }
                            }

                            MiniToggle {
                                label: "Pull";
                                checked: peer.allow-pull;
                                toggled => { root.permissions-changed(peer.allow-push, !peer.allow-pull, peer.allow-browse); }
                            }

                            MiniToggle {
                                label: "Browse";
                                checked: peer.allow-browse;
                                toggled => { root.permissions-changed(peer.allow-push, peer.allow-pull, !peer.allow-browse); }
                            }
                        }
                    }
                }

                // Speed test section
                HorizontalLayout {
                    spacing: Theme.spacing-md;
                    height: 32px;

                    // Speed test button
                    CompactButton {
                        label: peer.speed-test-running ? "Testing..." : "Speed Test";
                        enabled: peer.status == "online" && !peer.speed-test-running;
                        clicked => { root.speed-test-clicked(); }
                    }

                    // Speed test results (if available)
                    if peer.speed-test-upload != "" || peer.speed-test-download != "": HorizontalLayout {
                        spacing: Theme.spacing-md;

                        StatBox {
                            label: "UPLOAD";
                            value: peer.speed-test-upload;
                            value-color: Theme.success;
                        }

                        StatBox {
                            label: "DOWNLOAD";
                            value: peer.speed-test-download;
                            value-color: Theme.accent;
                        }

                        StatBox {
                            label: "LATENCY";
                            value: peer.speed-test-latency;
                            value-color: Theme.text-dim;
                        }
                    }

                    // Loading indicator while running
                    if peer.speed-test-running: Text {
                        text: "Running speed test...";
                        font-size: 11px;
                        color: Theme.text-muted;
                        vertical-alignment: center;
                    }

                    Rectangle { horizontal-stretch: 1; }
                }

                // Action buttons row
                HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    height: 28px;

                    Rectangle { horizontal-stretch: 1; }

                    // Connect button (enabled when disconnected)
                    CompactButton {
                        label: "Connect";
                        enabled: !peer.connected;
                        clicked => { root.connect-clicked(); }
                    }

                    // Disconnect button (enabled when connected)
                    CompactButton {
                        label: "Disconnect";
                        enabled: peer.connected;
                        clicked => { root.disconnect-clicked(); }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Network Card - Compact display for peer networks
// ============================================================================

component NetworkCard inherits Rectangle {
    in property <NetworkItem> network;
    in property <[PeerItem]> available-peers: [];  // Peers that can be added (not already members)
    in property <[PeerItem]> introducible-peers: [];  // Non-guest peers not in network (can be introduced)
    in-out property <bool> expanded: false;
    in-out property <string> rename-text: network.name;
    in-out property <bool> show-add-peer: false;   // Shows peer selection dropdown
    in-out property <bool> show-introduce: false;  // Shows introduction flow
    in-out property <string> introduce-peer-id: "";  // Selected peer to introduce
    in-out property <string> introduce-peer-name: "";  // Selected peer name (for display)
    callback delete-clicked();
    callback rename-clicked(string);  // new name
    callback add-peer(string);        // peer id to add
    callback remove-peer(string);     // peer id to remove
    callback introduce-peer(string, string);  // peer_to_introduce_id, target_member_id

    background: Theme.bg-card;
    border-radius: Theme.radius-sm;
    border-width: 1px;
    border-color: expanded ? Theme.accent : Theme.border;

    VerticalLayout {
        // Header row (always visible)
        HorizontalLayout {
            height: 52px;
            padding: Theme.spacing-sm;
            spacing: Theme.spacing-sm;

            // Network icon
            Rectangle {
                width: 32px;
                height: 32px;
                border-radius: 16px;
                background: Theme.accent-glow;

                Text {
                    text: "N";
                    font-size: 14px;
                    font-weight: 600;
                    color: Theme.accent;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Network info - clickable to expand
            TouchArea {
                horizontal-stretch: 1;
                mouse-cursor: pointer;
                clicked => { expanded = !expanded; }

                VerticalLayout {
                    spacing: 2px;

                    HorizontalLayout {
                        spacing: Theme.spacing-xs;

                        Text {
                            text: network.name;
                            font-size: 13px;
                            font-weight: 500;
                            color: Theme.text;
                            overflow: elide;
                        }

                        if network.is-owner: Rectangle {
                            width: 45px;
                            height: 14px;
                            border-radius: 3px;
                            background: Theme.accent-glow;

                            Text {
                                text: "Owner";
                                font-size: 9px;
                                color: Theme.accent;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    Text {
                        text: network.member-count == 1 ? "1 member" : network.member-count + " members";
                        font-size: 11px;
                        color: Theme.text-muted;
                    }
                }
            }

            // Expand/collapse chevron
            ImageIconBtn {
                icon: expanded ? @image-url("../assets/icons/chevron-up.svg") : @image-url("../assets/icons/chevron-down.svg");
                icon-color: Theme.text-muted;
                small: true;
                clicked => { expanded = !expanded; }
            }
        }

        // Expanded content
        if expanded : Rectangle {
            background: Theme.bg-hover;
            border-radius: 0;

            VerticalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-sm;

                // Description (if any)
                if network.description != "" : Text {
                    text: network.description;
                    font-size: 11px;
                    color: Theme.text-dim;
                    wrap: word-wrap;
                }

                // Network details
                HorizontalLayout {
                    spacing: Theme.spacing-md;

                    Text {
                        text: "Created: " + network.created-at;
                        font-size: 10px;
                        color: Theme.text-muted;
                    }

                    Text {
                        text: network.allow-introductions ? "Introductions: On" : "Introductions: Off";
                        font-size: 10px;
                        color: Theme.text-muted;
                    }
                }

                // Members section
                VerticalLayout {
                    spacing: Theme.spacing-xs;

                    HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        Text {
                            text: "Members";
                            font-size: 11px;
                            font-weight: 500;
                            color: Theme.text-dim;
                            vertical-alignment: center;
                        }

                        Rectangle { horizontal-stretch: 1; }

                        // Add Peer button (owner only)
                        if network.is-owner && available-peers.length > 0 : CompactButton {
                            label: show-add-peer ? "Cancel" : "Add Peer";
                            small: true;
                            clicked => { show-add-peer = !show-add-peer; }
                        }
                    }

                    // Add peer dropdown when visible
                    if show-add-peer && available-peers.length > 0 : Rectangle {
                        background: Theme.bg-card;
                        border-radius: Theme.radius-sm;
                        border-width: 1px;
                        border-color: Theme.border;

                        VerticalLayout {
                            padding: Theme.spacing-xs;
                            spacing: 2px;

                            for peer[idx] in available-peers : Rectangle {
                                // Only show non-guest, non-revoked peers
                                property <bool> show-peer: !peer.is-guest && !peer.revoked;
                                visible: show-peer;
                                height: show-peer ? 28px : 0px;

                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        root.add-peer(peer.id);
                                        show-add-peer = false;
                                    }

                                    Rectangle {
                                        background: parent.has-hover ? Theme.bg-hover : transparent;
                                        border-radius: Theme.radius-sm;

                                        HorizontalLayout {
                                            padding-left: Theme.spacing-sm;
                                            padding-right: Theme.spacing-sm;
                                            spacing: Theme.spacing-xs;

                                            Text {
                                                text: peer.name;
                                                font-size: 11px;
                                                color: Theme.text;
                                                vertical-alignment: center;
                                                overflow: elide;
                                            }

                                            Text {
                                                text: peer.status == "online" ? "(online)" : "(offline)";
                                                font-size: 10px;
                                                color: peer.status == "online" ? Theme.success : Theme.text-muted;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // Member list
                    if network.member-count == 0 : Text {
                        text: "No members yet";
                        font-size: 10px;
                        color: Theme.text-muted;
                    }

                    for member[idx] in network.members : HorizontalLayout {
                        height: 24px;
                        spacing: Theme.spacing-xs;
                        padding-left: Theme.spacing-xs;

                        Rectangle {
                            width: 6px;
                            height: 6px;
                            border-radius: 3px;
                            background: Theme.text-muted;
                            y: (parent.height - self.height) / 2;
                        }

                        Text {
                            text: member.name;
                            font-size: 11px;
                            color: Theme.text;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                        }

                        // Remove button (owner only)
                        if network.is-owner : ImageIconBtn {
                            icon: @image-url("../assets/icons/x.svg");
                            icon-color: Theme.text-muted;
                            small: true;
                            clicked => { root.remove-peer(member.peer-id); }
                        }
                    }
                }

                // Introduction section (when introductions enabled and we have members + peers to introduce)
                if network.allow-introductions && network.member-count > 0 && introducible-peers.length > 0 : VerticalLayout {
                    spacing: Theme.spacing-xs;

                    HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        Text {
                            text: "Introduce Peer";
                            font-size: 11px;
                            font-weight: 500;
                            color: Theme.text-dim;
                            vertical-alignment: center;
                        }

                        Rectangle { horizontal-stretch: 1; }

                        CompactButton {
                            label: show-introduce ? "Cancel" : "Start";
                            small: true;
                            clicked => {
                                show-introduce = !show-introduce;
                                introduce-peer-id = "";
                                introduce-peer-name = "";
                            }
                        }
                    }

                    // Step 1: Select peer to introduce
                    if show-introduce && introduce-peer-id == "" : VerticalLayout {
                        spacing: Theme.spacing-xs;

                        Text {
                            text: "Step 1: Click a peer to introduce:";
                            font-size: 10px;
                            color: Theme.text-muted;
                        }

                        Rectangle {
                            background: Theme.bg-card;
                            border-radius: Theme.radius-sm;
                            border-width: 1px;
                            border-color: Theme.border;
                            min-height: 32px;

                            VerticalLayout {
                                padding: Theme.spacing-xs;
                                spacing: 2px;

                                for peer[idx] in introducible-peers : Rectangle {
                                    // Only show non-guest, non-revoked peers that aren't already network members
                                    property <bool> show-peer: !peer.is-guest && !peer.revoked;
                                    visible: show-peer;
                                    height: show-peer ? 28px : 0px;

                                    TouchArea {
                                        mouse-cursor: pointer;
                                        clicked => {
                                            introduce-peer-id = peer.id;
                                            introduce-peer-name = peer.name;
                                        }

                                        Rectangle {
                                            background: parent.has-hover ? Theme.bg-hover : transparent;
                                            border-radius: Theme.radius-sm;

                                            HorizontalLayout {
                                                padding-left: Theme.spacing-sm;
                                                padding-right: Theme.spacing-sm;
                                                spacing: Theme.spacing-xs;

                                                Text {
                                                    text: "→";
                                                    font-size: 11px;
                                                    color: Theme.accent;
                                                    vertical-alignment: center;
                                                }

                                                Text {
                                                    text: peer.name;
                                                    font-size: 11px;
                                                    color: Theme.text;
                                                    vertical-alignment: center;
                                                    overflow: elide;
                                                }

                                                Text {
                                                    text: peer.status == "online" ? "(online)" : "(offline)";
                                                    font-size: 10px;
                                                    color: peer.status == "online" ? Theme.success : Theme.text-muted;
                                                    vertical-alignment: center;
                                                }
                                            }
                                        }
                                    }
                                }

                                // Show message if no eligible peers
                                Text {
                                    text: "No trusted peers available to introduce (only trusted, non-revoked peers can be introduced)";
                                    font-size: 10px;
                                    color: Theme.text-muted;
                                    wrap: word-wrap;
                                    visible: introducible-peers.length == 0;
                                }
                            }
                        }
                    }

                    // Step 2: Select network member to introduce them to
                    if show-introduce && introduce-peer-id != "" : VerticalLayout {
                        spacing: Theme.spacing-xs;

                        Text {
                            text: "Step 2: Click a member to introduce " + introduce-peer-name + " to:";
                            font-size: 10px;
                            color: Theme.text-muted;
                        }

                        Rectangle {
                            background: Theme.bg-card;
                            border-radius: Theme.radius-sm;
                            border-width: 1px;
                            border-color: Theme.border;

                            VerticalLayout {
                                padding: Theme.spacing-xs;
                                spacing: 2px;

                                for member[idx] in network.members : TouchArea {
                                    height: 28px;
                                    mouse-cursor: pointer;
                                    clicked => {
                                        root.introduce-peer(introduce-peer-id, member.peer-id);
                                        show-introduce = false;
                                        introduce-peer-id = "";
                                        introduce-peer-name = "";
                                    }

                                    Rectangle {
                                        background: parent.has-hover ? Theme.bg-hover : transparent;
                                        border-radius: Theme.radius-sm;

                                        HorizontalLayout {
                                            padding-left: Theme.spacing-sm;
                                            padding-right: Theme.spacing-sm;
                                            spacing: Theme.spacing-xs;

                                            Text {
                                                text: "→";
                                                font-size: 11px;
                                                color: Theme.accent;
                                                vertical-alignment: center;
                                            }

                                            Text {
                                                text: member.name;
                                                font-size: 11px;
                                                color: Theme.text;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // Rename section (owner only)
                if network.is-owner : HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    height: 28px;

                    Text {
                        text: "Rename:";
                        font-size: 11px;
                        color: Theme.text-dim;
                        vertical-alignment: center;
                    }

                    ThemedInput {
                        input-width: 140px;
                        text <=> rename-text;
                        placeholder-text: "Network name";
                        font-size: 11px;
                    }

                    CompactButton {
                        label: "Save";
                        small: true;
                        enabled: rename-text != network.name && rename-text != "";
                        clicked => {
                            root.rename-clicked(rename-text);
                        }
                    }
                }

                // Action buttons
                HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    height: 28px;

                    Rectangle { horizontal-stretch: 1; }

                    if network.is-owner : CompactButton {
                        label: "Delete Network";
                        small: true;
                        clicked => { root.delete-clicked(); }
                    }
                }
            }
        }
    }
}

component PeersPanel inherits Rectangle {
    background: Theme.bg-dark;

    VerticalBox {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        // Header with Add Peer button
        HorizontalLayout {
            spacing: Theme.spacing-sm;

            Text {
                text: "Trusted Peers";
                font-size: 14px;
                font-weight: 600;
                color: Theme.text;
                vertical-alignment: center;
                horizontal-stretch: 1;
            }

            // Show endpoint ID (truncated - done in Rust)
            if AppLogic.endpoint-id != "" : Text {
                text: "ID: " + AppLogic.endpoint-id;
                font-size: 10px;
                font-family: "monospace";
                color: Theme.text-muted;
                vertical-alignment: center;
            }

            CompactButton {
                label: AppLogic.trust-in-progress ? "Cancel" : "Add Peer";
                primary: !AppLogic.trust-in-progress;
                clicked => {
                    if AppLogic.trust-in-progress {
                        AppLogic.cancel-trust();
                        AppLogic.add-peer-as-guest = false;  // Reset toggle
                    } else {
                        AppLogic.initiate-trust(AppLogic.add-peer-as-guest);
                    }
                }
            }
        }

        // Guest mode toggle (shown when not in progress)
        if !AppLogic.trust-in-progress : HorizontalLayout {
            alignment: end;
            spacing: Theme.spacing-sm;

            MiniToggle {
                checked: AppLogic.add-peer-as-guest;
                label: "Add as guest (temporary)";
                toggled => {
                    AppLogic.add-peer-as-guest = !AppLogic.add-peer-as-guest;
                }
            }
        }

        // Trust in progress section
        if AppLogic.trust-in-progress : Section {
            VerticalBox {
                spacing: Theme.spacing-sm;
                padding: Theme.spacing-sm;

                Text {
                    text: AppLogic.add-peer-as-guest
                        ? "Share this code to add a temporary guest:"
                        : "Share this code with the peer you want to add:";
                    font-size: 12px;
                    color: Theme.text-dim;
                    horizontal-alignment: center;
                }

                if AppLogic.trust-code != "" : HorizontalLayout {
                    alignment: center;
                    spacing: Theme.spacing-sm;

                    Rectangle {
                        background: Theme.bg-hover;
                        border-radius: Theme.radius-sm;
                        height: 36px;
                        width: trust-code-text.preferred-width + 24px;

                        trust-code-text := Text {
                            text: AppLogic.trust-code;
                            font-size: 16px;
                            font-weight: 600;
                            font-family: "monospace";
                            color: Theme.accent;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    CompactButton {
                        label: AppLogic.copied-code == AppLogic.trust-code ? "Copied!" : "Copy";
                        clicked => { AppLogic.copy-code(AppLogic.trust-code); }
                    }
                }

                if AppLogic.trust-code == "" : Text {
                    text: "Generating code...";
                    font-size: 12px;
                    color: Theme.text-muted;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Waiting for peer to connect...";
                    font-size: 11px;
                    color: Theme.text-muted;
                    horizontal-alignment: center;
                }
            }
        }

        // Peers list
        Section {
            vertical-stretch: 1;

            if AppLogic.peers.length == 0 && !AppLogic.trust-in-progress : VerticalBox {
                alignment: center;
                spacing: Theme.spacing-sm;

                Text {
                    text: "No trusted peers yet";
                    font-size: 13px;
                    color: Theme.text-dim;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Click 'Add Peer' to establish a trusted connection";
                    font-size: 11px;
                    color: Theme.text-muted;
                    horizontal-alignment: center;
                }
            }

            if AppLogic.peers.length > 0 : ScrollView {
                VerticalBox {
                    spacing: Theme.spacing-xs;

                    for peer in AppLogic.peers : PeerCard {
                        peer: peer;
                        remove-clicked => { AppLogic.remove-peer(peer.id); }
                        disconnect-clicked => { AppLogic.disconnect-peer(peer.id); }
                        connect-clicked => { AppLogic.connect-peer(peer.id); }
                        push-clicked => { AppLogic.push-to-peer(peer.id); }
                        browse-clicked => { AppLogic.browse-peer(peer.id); }
                        refresh-clicked => { AppLogic.refresh-peer-status(peer.id); }
                        speed-test-clicked => { AppLogic.run-speed-test(peer.id); }
                        rename-clicked(new-name) => { AppLogic.rename-peer(peer.id, new-name); }
                        permissions-changed(push, pull, browse) => {
                            AppLogic.update-peer-permissions(peer.id, push, pull, browse);
                        }
                        expanded-changed(expanded) => {
                            AppLogic.set-peer-expanded(peer.id, expanded);
                        }
                    }
                }
            }
        }

        // Networks section
        Section {
            title: "Networks";

            property <string> new-network-name: "";
            property <bool> show-create-input: false;

            VerticalBox {
                spacing: Theme.spacing-xs;

                if AppLogic.networks.length == 0 && !show-create-input : Text {
                    text: "No networks yet. Create one to organize peers and enable introductions.";
                    font-size: 11px;
                    color: Theme.text-muted;
                    wrap: word-wrap;
                }

                for network in AppLogic.networks : NetworkCard {
                    network: network;
                    // Pass all non-guest peers - backend filters duplicates
                    available-peers: AppLogic.peers;
                    // Pass non-guest peers for introduction (same list, backend handles filtering)
                    introducible-peers: AppLogic.peers;
                    delete-clicked => { AppLogic.delete-network(network.id); }
                    rename-clicked(new-name) => { AppLogic.rename-network(network.id, new-name); }
                    add-peer(peer-id) => { AppLogic.add-peer-to-network(network.id, peer-id); }
                    remove-peer(peer-id) => { AppLogic.remove-peer-from-network(network.id, peer-id); }
                    introduce-peer(peer-to-introduce, target-member) => {
                        AppLogic.introduce-peers(network.id, peer-to-introduce, target-member);
                    }
                }

                // Create network input (shown when creating)
                if show-create-input : HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    height: 32px;

                    ThemedInput {
                        input-width: 160px;
                        text <=> new-network-name;
                        placeholder-text: "Network name";
                        font-size: 12px;
                    }

                    CompactButton {
                        label: "Create";
                        primary: true;
                        enabled: new-network-name != "";
                        clicked => {
                            AppLogic.create-network(new-network-name, "");
                            new-network-name = "";
                            show-create-input = false;
                        }
                    }

                    CompactButton {
                        label: "Cancel";
                        clicked => {
                            new-network-name = "";
                            show-create-input = false;
                        }
                    }
                }

                // Create network button (shown when not creating)
                if !show-create-input : HorizontalLayout {
                    alignment: center;
                    height: 32px;

                    CompactButton {
                        label: "+ Create Network";
                        clicked => { show-create-input = true; }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Settings Panel
// ============================================================================

component SettingsPanel inherits Rectangle {
    in-out property <string> download-dir: AppLogic.settings.download-dir;
    in-out property <string> relay: AppLogic.settings.default-relay;
    // Theme index mapping: 0=System, 1=Light, 2=Dark, 3=Dracula, 4=Nord,
    //   5=Solarized Dark, 6=Solarized Light, 7=Gruvbox Dark, 8=Gruvbox Light,
    //   9=Catppuccin Mocha, 10=Catppuccin Latte
    in-out property <int> theme-idx:
        AppLogic.settings.theme == "light" ? 1 :
        AppLogic.settings.theme == "dark" ? 2 :
        AppLogic.settings.theme == "dracula" ? 3 :
        AppLogic.settings.theme == "nord" ? 4 :
        AppLogic.settings.theme == "solarized-dark" ? 5 :
        AppLogic.settings.theme == "solarized-light" ? 6 :
        AppLogic.settings.theme == "gruvbox-dark" ? 7 :
        AppLogic.settings.theme == "gruvbox-light" ? 8 :
        AppLogic.settings.theme == "catppuccin-mocha" ? 9 :
        AppLogic.settings.theme == "catppuccin-latte" ? 10 : 0;
    // Transfer options
    in-out property <int> hash-idx: AppLogic.settings.hash-algorithm == "imohash" ? 1 :
                                     AppLogic.settings.hash-algorithm == "md5" ? 2 : 0;
    in-out property <int> curve-idx: AppLogic.settings.curve == "p256" ? 1 :
                                      AppLogic.settings.curve == "p384" ? 2 :
                                      AppLogic.settings.curve == "p521" ? 3 : 0;
    in-out property <string> throttle: AppLogic.settings.throttle;
    in-out property <bool> no-local: AppLogic.settings.no-local;

    // Theme names list for dropdown
    property <[string]> theme-names: ["System", "Light", "Dark", "Dracula", "Nord",
        "Solarized Dark", "Solarized Light", "Gruvbox Dark", "Gruvbox Light",
        "Catppuccin Mocha", "Catppuccin Latte"];

    // Helper function to trigger auto-save with current values
    pure function current-theme() -> string {
        return theme-idx == 0 ? "system" :
               theme-idx == 1 ? "light" :
               theme-idx == 2 ? "dark" :
               theme-idx == 3 ? "dracula" :
               theme-idx == 4 ? "nord" :
               theme-idx == 5 ? "solarized-dark" :
               theme-idx == 6 ? "solarized-light" :
               theme-idx == 7 ? "gruvbox-dark" :
               theme-idx == 8 ? "gruvbox-light" :
               theme-idx == 9 ? "catppuccin-mocha" :
               "catppuccin-latte";
    }
    pure function current-hash() -> string {
        return hash-idx == 0 ? "xxhash" : hash-idx == 1 ? "imohash" : "md5";
    }
    pure function current-curve() -> string {
        return curve-idx == 0 ? "siec" : curve-idx == 1 ? "p256" : curve-idx == 2 ? "p384" : "p521";
    }

    background: Theme.bg-dark;

    ScrollView {
        VerticalBox {
            padding: Theme.spacing-md;
            spacing: Theme.spacing-sm;

            // Device Identity
            Section {
                title: "Device Identity";

                SettingRow {
                    label: "Nickname";
                    sublabel: AppLogic.settings.device-nickname == "" ?
                        "Using hostname: " + AppLogic.settings.device-hostname :
                        "Hostname: " + AppLogic.settings.device-hostname;

                    ThemedInput {
                        input-width: 160px;
                        text: AppLogic.settings.device-nickname;
                        placeholder-text: AppLogic.settings.device-hostname;
                        font-size: 12px;
                        edited => {
                            AppLogic.set-device-nickname(self.text);
                        }
                    }
                }
            }

            // Downloads
            Section {
                title: "Downloads";

                SettingRow {
                    label: "Save Location";
                    sublabel: download-dir == "" ? "Default system downloads" : download-dir;

                    CompactButton {
                        label: "Browse";
                        clicked => { AppLogic.browse-download-dir(); }
                    }
                }
            }

            // Network
            Section {
                title: "Network";

                SettingRow {
                    label: "Custom Relay";
                    sublabel: "Leave empty for default";

                    ThemedInput {
                        input-width: 160px;
                        text <=> relay;
                        placeholder-text: "relay.example.com";
                        font-size: 12px;
                        edited => {
                            AppLogic.auto-save-settings(download-dir, relay, current-theme(), current-hash(), current-curve(), throttle, no-local);
                        }
                    }
                }

                SettingRow {
                    label: "Force Relay Only";
                    sublabel: "Disable local network transfers";

                    Rectangle {
                        width: 40px;
                        height: 22px;
                        border-radius: 11px;
                        background: no-local ? Theme.accent : Theme.bg-hover;
                        border-width: 1px;
                        border-color: Theme.border;

                        toggle-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                no-local = !no-local;
                                AppLogic.auto-save-settings(download-dir, relay, current-theme(), current-hash(), current-curve(), throttle, no-local);
                            }
                        }

                        Rectangle {
                            x: no-local ? parent.width - self.width - 2px : 2px;
                            y: 2px;
                            width: 18px;
                            height: 18px;
                            border-radius: 9px;
                            background: #ffffff;

                            animate x { duration: 150ms; easing: ease-out; }
                        }
                    }
                }
            }

            // Transfer Options
            Section {
                title: "Transfer Options";

                SettingRow {
                    label: "Hash Algorithm";
                    sublabel: "File verification method";

                    ThemedDropdown {
                        dropdown-width: 110px;
                        model: ["xxhash", "imohash", "md5"];
                        current-index <=> hash-idx;
                        changed(idx) => {
                            AppLogic.auto-save-settings(download-dir, relay, current-theme(), idx == 0 ? "xxhash" : idx == 1 ? "imohash" : "md5", current-curve(), throttle, no-local);
                        }
                    }
                }

                SettingRow {
                    label: "Encryption Curve";
                    sublabel: "PAKE elliptic curve";

                    ThemedDropdown {
                        dropdown-width: 110px;
                        model: ["siec", "p256", "p384", "p521"];
                        current-index <=> curve-idx;
                        changed(idx) => {
                            AppLogic.auto-save-settings(download-dir, relay, current-theme(), current-hash(), idx == 0 ? "siec" : idx == 1 ? "p256" : idx == 2 ? "p384" : "p521", throttle, no-local);
                        }
                    }
                }

                SettingRow {
                    label: "Bandwidth Limit";
                    sublabel: "e.g. 1M, 500K (empty = unlimited)";

                    ThemedInput {
                        input-width: 110px;
                        text <=> throttle;
                        placeholder-text: "unlimited";
                        font-size: 12px;
                        edited => {
                            AppLogic.auto-save-settings(download-dir, relay, current-theme(), current-hash(), current-curve(), throttle, no-local);
                        }
                    }
                }
            }

            // File Sharing (peer browsing settings)
            Section {
                title: "File Sharing";

                SettingRow {
                    label: "Show Hidden Files";
                    sublabel: "Files starting with '.'";

                    Rectangle {
                        width: 40px;
                        height: 22px;
                        border-radius: 11px;
                        background: AppLogic.settings.browse-show-hidden ? Theme.accent : Theme.bg-hover;
                        border-width: 1px;
                        border-color: Theme.border;

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                AppLogic.save-browse-settings(
                                    !AppLogic.settings.browse-show-hidden,
                                    AppLogic.settings.browse-show-protected,
                                    AppLogic.settings.browse-exclude-patterns
                                );
                            }
                        }

                        Rectangle {
                            x: AppLogic.settings.browse-show-hidden ? parent.width - self.width - 2px : 2px;
                            y: 2px;
                            width: 18px;
                            height: 18px;
                            border-radius: 9px;
                            background: #ffffff;

                            animate x { duration: 150ms; easing: ease-out; }
                        }
                    }
                }

                SettingRow {
                    label: "Show Protected Dirs";
                    sublabel: ".ssh, .gnupg, .config, etc.";

                    Rectangle {
                        width: 40px;
                        height: 22px;
                        border-radius: 11px;
                        background: AppLogic.settings.browse-show-protected ? Theme.accent : Theme.bg-hover;
                        border-width: 1px;
                        border-color: Theme.border;

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                AppLogic.save-browse-settings(
                                    AppLogic.settings.browse-show-hidden,
                                    !AppLogic.settings.browse-show-protected,
                                    AppLogic.settings.browse-exclude-patterns
                                );
                            }
                        }

                        Rectangle {
                            x: AppLogic.settings.browse-show-protected ? parent.width - self.width - 2px : 2px;
                            y: 2px;
                            width: 18px;
                            height: 18px;
                            border-radius: 9px;
                            background: #ffffff;

                            animate x { duration: 150ms; easing: ease-out; }
                        }
                    }
                }

                SettingRow {
                    label: "Exclude Patterns";
                    sublabel: "Comma-separated (e.g. node_modules, *.tmp)";

                    ThemedInput {
                        input-width: 200px;
                        text: AppLogic.settings.browse-exclude-patterns;
                        placeholder-text: "node_modules, .git, *.tmp";
                        font-size: 12px;
                        edited => {
                            AppLogic.save-browse-settings(
                                AppLogic.settings.browse-show-hidden,
                                AppLogic.settings.browse-show-protected,
                                self.text
                            );
                        }
                    }
                }
            }

            // Do Not Disturb
            Section {
                title: "Do Not Disturb";

                SettingRow {
                    label: "Status";
                    sublabel: AppLogic.settings.dnd-mode == "off" ? "Available for transfers" :
                              AppLogic.settings.dnd-mode == "silent" ? "Receive but silence notifications" :
                              "Reject incoming transfer requests";

                    ThemedDropdown {
                        dropdown-width: 100px;
                        model: ["Off", "Silent", "Busy"];
                        current-index: AppLogic.settings.dnd-mode == "silent" ? 1 :
                                       AppLogic.settings.dnd-mode == "busy" ? 2 : 0;
                        changed(idx) => {
                            AppLogic.set-dnd-mode(
                                idx == 0 ? "off" : idx == 1 ? "silent" : "busy",
                                AppLogic.settings.dnd-message
                            );
                        }
                    }
                }

                if AppLogic.settings.dnd-mode != "off": SettingRow {
                    label: "Status Message";
                    sublabel: "Optional message shown to peers";

                    ThemedInput {
                        input-width: 180px;
                        text: AppLogic.settings.dnd-message;
                        placeholder-text: "Away from keyboard...";
                        font-size: 12px;
                        edited => {
                            AppLogic.set-dnd-mode(AppLogic.settings.dnd-mode, self.text);
                        }
                    }
                }
            }

            // Privacy
            Section {
                title: "Privacy";

                SettingRow {
                    label: "Show Session Stats";
                    sublabel: "Display upload/download totals in header";

                    Rectangle {
                        width: 40px;
                        height: 22px;
                        border-radius: 11px;
                        background: AppLogic.settings.show-session-stats ? Theme.accent : Theme.bg-hover;
                        border-width: 1px;
                        border-color: Theme.border;

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                AppLogic.toggle-session-stats();
                            }
                        }

                        Rectangle {
                            x: AppLogic.settings.show-session-stats ? parent.width - self.width - 2px : 2px;
                            y: 2px;
                            width: 18px;
                            height: 18px;
                            border-radius: 9px;
                            background: #ffffff;

                            animate x { duration: 150ms; easing: ease-out; }
                        }
                    }
                }
            }

            // Transfers
            Section {
                title: "Transfers";

                SettingRow {
                    label: "Keep Completed Transfers";
                    sublabel: "Keep transfers in list after completion";

                    Rectangle {
                        width: 40px;
                        height: 22px;
                        border-radius: 11px;
                        background: AppLogic.settings.keep-completed-transfers ? Theme.accent : Theme.bg-hover;
                        border-width: 1px;
                        border-color: Theme.border;

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                AppLogic.toggle-keep-completed-transfers();
                            }
                        }

                        Rectangle {
                            x: AppLogic.settings.keep-completed-transfers ? parent.width - self.width - 2px : 2px;
                            y: 2px;
                            width: 18px;
                            height: 18px;
                            border-radius: 9px;
                            background: #ffffff;

                            animate x { duration: 150ms; easing: ease-out; }
                        }
                    }
                }
            }

            // Security
            Section {
                title: "Security";

                SettingRow {
                    label: "Security Posture";
                    sublabel: AppLogic.settings.security-posture == "relaxed" ? "Maximum convenience, minimal friction" :
                              AppLogic.settings.security-posture == "cautious" ? "Tighter security, more confirmations" :
                              "Balanced - good for most users";

                    ThemedDropdown {
                        dropdown-width: 110px;
                        model: ["Relaxed", "Balanced", "Cautious"];
                        current-index: AppLogic.settings.security-posture == "relaxed" ? 0 :
                                       AppLogic.settings.security-posture == "cautious" ? 2 : 1;
                        changed(idx) => {
                            AppLogic.set-security-posture(
                                idx == 0 ? "relaxed" : idx == 2 ? "cautious" : "balanced"
                            );
                        }
                    }
                }

                // Show posture-specific info
                if AppLogic.settings.security-posture == "relaxed": SettingRow {
                    label: "Guest Duration";
                    sublabel: "1 week default, 2 weeks max";
                }

                if AppLogic.settings.security-posture == "balanced": SettingRow {
                    label: "Guest Duration";
                    sublabel: "3 days default, 1 week max";
                }

                if AppLogic.settings.security-posture == "cautious": SettingRow {
                    label: "Guest Duration";
                    sublabel: "24 hours default, 48 hours max";
                }
            }

            // Appearance
            Section {
                title: "Appearance";

                SettingRow {
                    label: "Theme";

                    ThemedDropdown {
                        dropdown-width: 150px;
                        model: theme-names;
                        current-index <=> theme-idx;
                        changed(idx) => {
                            // Live theme preview + auto-save
                            AppLogic.set-theme(current-theme());
                        }
                    }
                }
            }

            // About
            Section {
                title: "About";

                SettingRow {
                    label: "Croc";
                    sublabel: AppLogic.settings.croc-found ? AppLogic.settings.croc-path : "Not found - required for transfers";

                    HorizontalLayout {
                        spacing: 4px;
                        alignment: center;

                        Rectangle {
                            width: 60px;
                            height: 20px;

                            Text {
                                text: AppLogic.settings.croc-found ? "[OK]" : "[Missing]";
                                font-size: 11px;
                                color: AppLogic.settings.croc-found ? Theme.success : Theme.error;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        CompactButton {
                            label: "Refresh";
                            clicked => { AppLogic.refresh-croc(); }
                        }

                        if !AppLogic.settings.croc-found: CompactButton {
                            label: "Install";
                            primary: true;
                            clicked => { AppLogic.install-croc(); }
                        }
                    }
                }

                SettingRow {
                    label: "Version";
                    sublabel: "Croh v0.1.0";

                    CompactButton {
                        label: "Config";
                        clicked => { AppLogic.open-config-folder(); }
                    }
                }
            }

            // Save
            HorizontalBox {
                Rectangle { horizontal-stretch: 1; }

                CompactButton {
                    label: "Save Settings";
                    primary: true;
                    clicked => {
                        AppLogic.save-settings(
                            download-dir,
                            relay,
                            current-theme(),
                            current-hash(),
                            current-curve(),
                            throttle,
                            no-local
                        );
                    }
                }
            }
        }
    }
}

// ============================================================================
// Resize Handle (draggable divider)
// ============================================================================

component ResizeHandle inherits Rectangle {
    callback dragged(length);

    height: 6px;
    background: touch.has-hover || touch.pressed ? Theme.border-focus : Theme.border;

    touch := TouchArea {
        mouse-cursor: row-resize;
        moved => {
            if (self.pressed) {
                root.dragged(self.mouse-y);
            }
        }
    }

    // Visual grip indicator
    Rectangle {
        x: (parent.width - 40px) / 2;
        y: 2px;
        width: 40px;
        height: 2px;
        background: touch.has-hover || touch.pressed ? Theme.accent : Theme.text-muted;
        border-radius: 1px;
    }
}

// ============================================================================
// Transfers Panel (bottom bar) - grows with window
// ============================================================================

component TransfersBar inherits Rectangle {
    background: Theme.bg-card;
    border-width: 1px;
    border-color: Theme.border;

    VerticalLayout {
        padding: 6px;
        padding-left: 8px;
        padding-right: 8px;
        spacing: 4px;

        // Header
        Text {
            text: "Transfers (" + AppLogic.transfers.length + ")";
            font-size: 10px;
            color: Theme.text-muted;
        }

        // Content
        if AppLogic.transfers.length == 0: Text {
            text: "No transfers";
            font-size: 10px;
            color: Theme.text-muted;
            horizontal-alignment: center;
            vertical-alignment: center;
            vertical-stretch: 1;
        }

        // Transfer list - scrollable
        if AppLogic.transfers.length > 0: ScrollView {
            vertical-stretch: 1;

            VerticalLayout {
                spacing: 4px;

                for transfer in AppLogic.transfers: TransferCard {
                    transfer: transfer;
                }
            }
        }
    }
}

// ============================================================================
// File Browser Entry
// ============================================================================

component BrowseEntryRow inherits Rectangle {
    in property <BrowseEntry> entry;
    in property <int> index;
    callback clicked();
    callback shift-clicked();  // Called when shift+click for range selection
    callback double-clicked();

    height: 28px;
    background: entry.selected ? Theme.accent-glow : (touch.has-hover ? Theme.bg-hover : transparent);
    border-radius: Theme.radius-sm;

    touch := TouchArea {
        mouse-cursor: pointer;
        // Use pointer-event to detect shift modifier
        pointer-event(event) => {
            if event.kind == PointerEventKind.up && event.button == PointerEventButton.left {
                if event.modifiers.shift {
                    root.shift-clicked();
                } else {
                    root.clicked();
                }
            }
        }
        double-clicked => { root.double-clicked(); }
    }

    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 8px;

        // Icon
        Image {
            source: entry.is-dir ? Icons.folder : Icons.file;
            width: 16px;
            height: 16px;
            colorize: entry.is-dir ? Theme.accent : Theme.text-muted;
            vertical-alignment: center;
        }

        // Name
        Text {
            text: entry.name;
            font-size: 12px;
            color: Theme.text;
            overflow: elide;
            horizontal-stretch: 1;
            vertical-alignment: center;
        }

        // Size (files only)
        if !entry.is-dir: Text {
            text: entry.size;
            font-size: 11px;
            color: Theme.text-muted;
            vertical-alignment: center;
            width: 70px;
            horizontal-alignment: right;
        }

        // Selection indicator (files only)
        if !entry.is-dir: Rectangle {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border-width: 1px;
            border-color: entry.selected ? Theme.accent : Theme.border;
            background: entry.selected ? Theme.accent : transparent;

            if entry.selected: Image {
                source: Icons.check;
                width: 12px;
                height: 12px;
                colorize: Theme.accent-text;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

// ============================================================================
// File Browser Dialog
// ============================================================================

component FileBrowserDialog inherits Rectangle {
    background: #00000080;

    // Click outside to close
    touch := TouchArea {
        clicked => { AppLogic.browse-close(); }
    }

    // Dialog panel
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: min(parent.width - 40px, 600px);
        height: min(parent.height - 60px, 500px);
        background: Theme.bg-card;
        border-radius: Theme.radius-md;
        border-width: 1px;
        border-color: Theme.border;

        // Prevent clicks from closing
        TouchArea {}

        VerticalLayout {
            padding: 0;
            spacing: 0;

            // Header
            Rectangle {
                height: 44px;
                background: Theme.bg-dark;
                border-top-left-radius: Theme.radius-md;
                border-top-right-radius: Theme.radius-md;

                HorizontalLayout {
                    padding: Theme.spacing-sm;
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "Browse: " + AppLogic.browse-peer-name;
                        font-size: 14px;
                        font-weight: 600;
                        color: Theme.text;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    ImageIconBtn {
                        icon: Icons.x;
                        icon-color: Theme.text-muted;
                        clicked => { AppLogic.browse-close(); }
                    }
                }
            }

            // Breadcrumb / Path
            Rectangle {
                height: 36px;
                background: Theme.bg-hover;

                HorizontalLayout {
                    padding-left: Theme.spacing-sm;
                    padding-right: Theme.spacing-sm;
                    spacing: Theme.spacing-xs;

                    // Up button
                    CompactButton {
                        label: "↑ Up";
                        enabled: AppLogic.browse-current-path != "/";
                        clicked => {
                            // Navigate to parent
                            AppLogic.browse-navigate("..");
                        }
                    }

                    // Current path
                    Text {
                        text: AppLogic.browse-current-path;
                        font-size: 12px;
                        font-family: "monospace";
                        color: Theme.text-dim;
                        overflow: elide;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }
                }
            }

            // Content area
            Rectangle {
                vertical-stretch: 1;
                background: Theme.bg-card;

                // Loading indicator
                if AppLogic.browse-loading: VerticalLayout {
                    alignment: center;
                    Text {
                        text: "Loading...";
                        font-size: 13px;
                        color: Theme.text-muted;
                        horizontal-alignment: center;
                    }
                }

                // Error message with Go Back button
                if AppLogic.browse-error != "" && !AppLogic.browse-loading: VerticalLayout {
                    alignment: center;
                    padding: Theme.spacing-md;
                    spacing: Theme.spacing-md;

                    Text {
                        text: "Error";
                        font-size: 14px;
                        font-weight: 600;
                        color: Theme.error;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: AppLogic.browse-error;
                        font-size: 12px;
                        color: Theme.text-dim;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                    }

                    // Go back button - navigate to previous successful path if available
                    HorizontalLayout {
                        alignment: center;
                        spacing: Theme.spacing-sm;

                        CompactButton {
                            label: "↑ Go Back";
                            primary: true;
                            enabled: AppLogic.browse-previous-path != "";
                            clicked => {
                                // Navigate to the last successful path
                                AppLogic.browse-navigate(AppLogic.browse-previous-path);
                            }
                        }
                    }
                }

                // File list
                if !AppLogic.browse-loading && AppLogic.browse-error == "": ScrollView {
                    VerticalLayout {
                        padding: Theme.spacing-xs;
                        spacing: 2px;

                        if AppLogic.browse-entries.length == 0: Text {
                            text: "No files found";
                            font-size: 12px;
                            color: Theme.text-muted;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        for entry[i] in AppLogic.browse-entries: BrowseEntryRow {
                            entry: entry;
                            index: i;
                            clicked => {
                                if entry.is-dir {
                                    // Navigate into directory
                                    AppLogic.browse-navigate(entry.path);
                                } else {
                                    // Toggle selection and remember as anchor for shift-select
                                    AppLogic.browse-toggle-select(i);
                                    AppLogic.browse-last-selected-index = i;
                                }
                            }
                            shift-clicked => {
                                // Range selection from last-selected to this index
                                if !entry.is-dir {
                                    AppLogic.browse-range-select(i);
                                    // Update anchor to this index for next shift-click
                                    AppLogic.browse-last-selected-index = i;
                                }
                            }
                            double-clicked => {
                                if entry.is-dir {
                                    AppLogic.browse-navigate(entry.path);
                                }
                            }
                        }
                    }
                }
            }

            // Footer with actions
            Rectangle {
                height: 50px;
                background: Theme.bg-dark;

                HorizontalLayout {
                    padding: Theme.spacing-md;
                    spacing: Theme.spacing-md;

                    // Selection hint
                    Text {
                        text: "Click to select, Shift+click for range";
                        font-size: 12px;
                        color: Theme.text-dim;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    CompactButton {
                        label: "Cancel";
                        clicked => { AppLogic.browse-close(); }
                    }

                    CompactButton {
                        label: "Pull Selected";
                        primary: true;
                        enabled: AppLogic.browse-selected-count > 0;
                        clicked => { AppLogic.browse-pull-selected(); }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Main Window
// ============================================================================

export component MainWindow inherits Window {
    title: "Croh";
    min-width: 480px;
    min-height: 400px;
    preferred-width: 700px;
    preferred-height: 600px;
    background: Theme.bg-dark;

    property <int> active-tab: 0;
    property <length> transfers-height: 150px;

    VerticalLayout {
        spacing: 0;

        // Header with rich status bar
        Rectangle {
            height: 40px;
            background: Theme.bg-card;
            border-width: 1px;
            border-color: Theme.border;

            HorizontalLayout {
                padding: 8px;
                padding-left: 12px;
                padding-right: 12px;
                spacing: 12px;

                // App name
                Text {
                    text: "Croh";
                    font-size: 14px;
                    font-weight: 600;
                    color: Theme.text;
                    vertical-alignment: center;
                }

                // Peer status badge
                StatBadge {
                    icon: Icons.users;
                    value: AppLogic.online-peer-count + "/" + AppLogic.total-peer-count;
                    value-color: AppLogic.online-peer-count > 0 ? Theme.success : Theme.text-muted;
                    tooltip-text: "Online / Total peers";
                }

                // Active transfers badge
                if AppLogic.active-transfer-count > 0: StatBadge {
                    icon: Icons.activity;
                    value: AppLogic.active-transfer-count + " active";
                    value-color: Theme.accent;
                    tooltip-text: "Active transfers";
                }

                // Spacer
                Rectangle { horizontal-stretch: 1; }

                // Session stats (when enabled)
                if AppLogic.settings.show-session-stats: HorizontalLayout {
                    spacing: 8px;

                    // Upload total
                    StatBadge {
                        icon: Icons.arrow-up;
                        value: AppLogic.session-stats.total-uploaded;
                        value-color: Theme.send-color;
                        tooltip-text: "Total uploaded this session";
                    }

                    // Download total
                    StatBadge {
                        icon: Icons.arrow-down;
                        value: AppLogic.session-stats.total-downloaded;
                        value-color: Theme.receive-color;
                        tooltip-text: "Total downloaded this session";
                    }
                }

                // Status text (errors, etc)
                if AppLogic.app-status != "Ready" && AppLogic.app-status != "": Text {
                    text: AppLogic.app-status;
                    font-size: 11px;
                    color: Theme.text-dim;
                    vertical-alignment: center;
                }
            }
        }

        // Tabs
        Rectangle {
            height: 40px;
            background: Theme.bg-dark;

            HorizontalLayout {
                padding: 4px;
                padding-left: 8px;
                padding-right: 8px;

                PillTabs {
                    tabs: ["Send", "Receive", "Peers", "Settings"];
                    current <=> active-tab;
                }
            }
        }

        // Content - stretches to fill remaining space
        Rectangle {
            vertical-stretch: 1;

            if active-tab == 0: SendPanel {}
            if active-tab == 1: ReceivePanel {}
            if active-tab == 2: PeersPanel {}
            if active-tab == 3: SettingsPanel {}
        }

        // Resize handle
        ResizeHandle {
            dragged(delta) => {
                // Subtract delta to resize (dragging up = larger transfers pane)
                transfers-height = clamp(transfers-height - delta, 60px, 400px);
            }
        }

        // Transfers bar - user-resizable height
        TransfersBar {
            height: transfers-height;
        }
    }

    // File browser overlay
    if AppLogic.browse-open: FileBrowserDialog {}
}
